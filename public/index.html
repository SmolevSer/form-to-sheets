<UPDATED_CODE><!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Система учета финансовых операций</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-attachment: fixed;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(120, 119, 198, 0.2) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            overflow: hidden;
        }

        #auth-form, #main-form {
            padding: 40px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2d3748;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        input, textarea, select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid rgba(102, 126, 234, 0.2);
            border-radius: 12px;
            font-size: 16px;
            box-sizing: border-box;
            background: rgba(255, 255, 255, 0.9);
            transition: all 0.3s ease;
            color: #2d3748;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
            background: rgba(255, 255, 255, 1);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 25px;
        }

        .btn {
            padding: 14px 24px;
            border: 2px solid #667eea;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            background: rgba(255, 255, 255, 0.9);
            color: #667eea;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
            transform: translateY(-1px);
        }

        .btn.submit {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            border-color: #48bb78;
            color: white;
            font-size: 18px;
            padding: 18px 36px;
            box-shadow: 0 10px 30px rgba(72, 187, 120, 0.3);
        }

        .btn.submit:hover {
            background: linear-gradient(135deg, #38a169 0%, #2f855a 100%);
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(72, 187, 120, 0.4);
        }

        .logout-btn {
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
            border-color: #f56565;
            color: white;
            padding: 10px 20px;
            font-size: 14px;
        }

        .logout-btn:hover {
            background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(245, 101, 101, 0.3);
        }

        .hidden {
            display: none;
        }

        .error {
            color: #e53e3e;
            margin-top: 15px;
            padding: 12px;
            background: rgba(245, 101, 101, 0.1);
            border-radius: 8px;
            border-left: 4px solid #e53e3e;
        }

        .success {
            color: #38a169;
            margin-top: 15px;
            padding: 12px;
            background: rgba(72, 187, 120, 0.1);
            border-radius: 8px;
            border-left: 4px solid #38a169;
        }

        .section {
            margin-bottom: 35px;
            padding: 25px;
            border: 1px solid rgba(102, 126, 234, 0.2);
            border-radius: 16px;
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(5px);
            transition: all 0.3s ease;
        }

        .section:hover {
            background: rgba(255, 255, 255, 0.8);
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .section-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
            color: #2d3748;
            position: relative;
            padding-bottom: 10px;
        }

        .section-title::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 50px;
            height: 3px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 2px;
        }

        .info-text {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            padding: 16px;
            border-radius: 12px;
            margin-top: 20px;
            font-style: italic;
            color: #4a5568;
            border-left: 4px solid #667eea;
        }

        .search-container {
            position: relative;
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(102, 126, 234, 0.2);
            border-top: none;
            max-height: 250px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            border-radius: 0 0 12px 12px;
            margin-top: 1px;
        }

        .search-result-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid rgba(102, 126, 234, 0.1);
            transition: all 0.2s ease;
        }

        .search-result-item:hover {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            transform: translateX(4px);
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .add-btn {
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
            border-color: #4299e1;
            color: white;
            padding: 12px 18px;
            font-size: 14px;
            min-width: 50px;
        }

        .add-btn:hover {
            background: linear-gradient(135deg, #3182ce 0%, #2c5282 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(66, 153, 225, 0.3);
        }

        .inline-add {
            display: flex;
            gap: 12px;
            margin-top: 15px;
        }

        .inline-add input {
            flex: 1;
        }

        .date-input, .amount-input {
            width: 220px;
        }

        .current-user {
            text-align: right;
            margin-bottom: 25px;
            color: #4a5568;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid rgba(102, 126, 234, 0.2);
        }

        .btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        .section.locked .btn:not(.active) {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        .table-container {
            margin-top: 25px;
            overflow-x: auto;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        #operations-history {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            overflow: hidden;
        }

        #operations-history th,
        #operations-history td {
            padding: 16px;
            text-align: left;
            border-bottom: 1px solid rgba(102, 126, 234, 0.1);
        }

        #operations-history th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-weight: 600;
            color: white;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 12px;
        }

        #operations-history tr:hover {
            background: rgba(102, 126, 234, 0.05);
        }

        .delete-btn {
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .delete-btn:hover {
            background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(245, 101, 101, 0.3);
        }

        .deleted-row {
            opacity: 0.5;
            text-decoration: line-through;
        }

        .deleted-row .delete-btn {
            display: none;
        }

        .session-timer {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 25px;
            text-align: center;
            font-weight: 600;
            color: #4a5568;
            border: 1px solid rgba(102, 126, 234, 0.2);
        }

        .session-timer.warning {
            background: linear-gradient(135deg, rgba(245, 101, 101, 0.1) 0%, rgba(229, 62, 62, 0.1) 100%);
            color: #c53030;
            border-color: rgba(245, 101, 101, 0.3);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        optgroup {
            font-weight: bold;
            color: #4a5568;
            background-color: rgba(102, 126, 234, 0.05);
            font-size: 14px;
        }

        optgroup option {
            font-weight: normal;
            color: #2d3748;
            padding-left: 10px;
            font-size: 14px;
        }

        .search-article-name {
            font-weight: 500;
            color: #2d3748;
            margin-bottom: 4px;
        }

        .search-category-name {
            font-size: 12px;
            color: #718096;
            font-style: italic;
        }

        .search-more-results {
            padding: 10px 16px;
            font-size: 12px;
            color: #718096;
            font-style: italic;
            background: rgba(102, 126, 234, 0.05);
        }

        .search-no-results {
            padding: 16px;
            font-size: 14px;
            color: #718096;
            text-align: center;
            font-style: italic;
        }

        mark {
            background: linear-gradient(135deg, #fef5e7 0%, #fed7aa 100%);
            padding: 2px 4px;
            border-radius: 4px;
            font-weight: 600;
        }

        select {
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23667eea' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 16px center;
            background-size: 16px;
            padding-right: 50px;
        }

        h2 {
            color: #2d3748;
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 30px;
            text-align: center;
            position: relative;
        }

        h2::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 4px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 2px;
        }

        /* Анимации для появления секций */
        .section {
            animation: slideInUp 0.5s ease-out;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Улучшенные скроллбары */
        .search-results::-webkit-scrollbar,
        .table-container::-webkit-scrollbar {
            width: 8px;
        }

        .search-results::-webkit-scrollbar-track,
        .table-container::-webkit-scrollbar-track {
            background: rgba(102, 126, 234, 0.1);
            border-radius: 4px;
        }

        .search-results::-webkit-scrollbar-thumb,
        .table-container::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 4px;
        }

        .search-results::-webkit-scrollbar-thumb:hover,
        .table-container::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
        }

        /* Адаптивность */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            #auth-form, #main-form {
                padding: 20px;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                text-align: center;
            }
            
            .search-container {
                flex-direction: column;
                gap: 8px;
            }
            
            .inline-add {
                flex-direction: column;
            }
            
            .date-input, .amount-input {
                width: 100%;
            }
            
            .current-user {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
            
            #operations-history {
                font-size: 14px;
            }
            
            #operations-history th,
            #operations-history td {
                padding: 8px;
            }
        }

        @media (max-width: 480px) {
            h2 {
                font-size: 24px;
            }
            
            .section-title {
                font-size: 18px;
            }
            
            .btn {
                padding: 12px 16px;
                font-size: 14px;
            }
            
            .btn.submit {
                font-size: 16px;
                padding: 16px 24px;
            }
        }


    </style>
</head>
<body>
    <div class="container">
        <!-- Форма аутентификации -->
        <div id="auth-form">
            <h2>Вход в систему учета операций</h2>
            <div class="form-group">
                <label for="login">Логин:</label>
                <input type="text" id="login" required>
            </div>
            <div class="form-group">
                <label for="password">Пароль:</label>
                <input type="password" id="password" required>
            </div>
            <button class="btn submit" onclick="authenticate()">Войти</button>
            <div id="auth-error" class="error"></div>
        </div>

        <!-- Основная форма -->
        <div id="main-form" class="hidden">
            <!-- Таймер сессии -->
            <div id="session-timer" class="session-timer">
                Время до истечения сессии: <span id="timer-display">--:--</span>
            </div>
            
            <div class="current-user">
                <span>Пользователь: <strong id="current-user-name"></strong></span>
                <button class="btn logout-btn" onclick="logout()">Выйти</button>
            </div>
            
            <h2>Учет финансовых операций</h2>
            
            <!-- Выбор компании -->
            <div class="section">
                <div class="section-title">1. Выберите компанию:</div>
                <div class="button-group">
                    <button id="btn-company-mozaika" class="btn" onclick="selectCompany('Мозаика')">Мозаика</button>
                    <button id="btn-company-kampus" class="btn" onclick="selectCompany('Кампус')">Кампус</button>
                    <button id="btn-company-haigora" class="btn" onclick="selectCompany('Хай-Гора')">Хай-Гора</button>
                </div>
            </div>

            <!-- Выбор операции -->
            <div id="operation-section" class="section hidden">
                <div class="section-title">2. Выберите тип операции:</div>
                <div class="button-group">
                    <button class="btn" onclick="selectOperation('Приход')">Приход</button>
                    <button class="btn" onclick="selectOperation('Расход')">Расход</button>
                    <button class="btn" onclick="selectOperation('Перевод между счетами')">Перевод между счетами</button>
                    <button class="btn" onclick="selectOperation('Перевод между СВОИМИ компаниями')">Перевод между СВОИМИ компаниями</button>
                </div>
            </div>

            <!-- Выбор счета -->
            <div id="account-section" class="section hidden">
                <div class="section-title">3. Выберите счет списания:</div>
                <div class="button-group">
                    <button class="btn" onclick="selectAccount('Касса')">Касса</button>
                    <button class="btn" onclick="selectAccount('ИП-3564')">ИП-3564</button>
                    <button class="btn" onclick="selectAccount('ИП-7435')">ИП-7435</button>
                    <button class="btn" onclick="selectAccount('ИП-Акбарс')">ИП-Акбарс</button>
                    <button class="btn" onclick="selectAccount('АНО-Сбер')">АНО-Сбер</button>
                </div>
            </div>

            <!-- Блок "Перевод между счетами" -->
            <div id="transfer-internal-block" class="section hidden">
                <div class="section-title">Перевод между счетами</div>
                
                <div class="form-group">
                    <label for="amount-internal">Сумма:</label>
                    <input type="number" id="amount-internal" class="amount-input" step="0.01" placeholder="0,00">
                </div>

                <div class="form-group">
                    <label for="payment-date-internal">Дата оплаты:</label>
                    <input type="date" id="payment-date-internal" class="date-input">
                </div>

                <div class="form-group">
                    <label for="target-account-internal">Счет для зачисления:</label>
                    <select id="target-account-internal">
                        <option value="">-- Выберите счет --</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="comment-internal">Комментарии:</label>
                    <textarea id="comment-internal" rows="3"></textarea>
                </div>

                <div class="info-text">
                    В данной форме отражается только переводы между счетами одной компании.
                </div>
            </div>

            <!-- Блок "Перевод между СВОИМИ компаниями" -->
            <div id="transfer-company-block" class="section hidden">
                <div class="section-title">Перевод между СВОИМИ компаниями</div>
                
                <div class="form-group">
                    <label for="amount-company">Сумма:</label>
                    <input type="number" id="amount-company" class="amount-input" step="0.01" placeholder="0,00">
                </div>

                <div class="form-group">
                    <label for="payment-date-company">Дата оплаты:</label>
                    <input type="date" id="payment-date-company" class="date-input">
                </div>

                <div class="form-group">
                    <label for="target-company">Компания получатель:</label>
                    <select id="target-company">
                        <option value="">-- Выберите компанию --</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="target-account-company">Счет для зачисления:</label>
                    <select id="target-account-company">
                        <option value="">-- Выберите счет --</option>
                        <option value="Касса">Касса</option>
                        <option value="ИП-3564">ИП-3564</option>
                        <option value="ИП-7435">ИП-7435</option>
                        <option value="ИП-Акбарс">ИП-Акбарс</option>
                        <option value="АНО-Сбер">АНО-Сбер</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="comment-company">Комментарии:</label>
                    <textarea id="comment-company" rows="3"></textarea>
                </div>

                <div class="info-text">
                    В данной форме отражается только РАСХОДНАЯ операция по счету. Приход на указанную компанию будет отражен автоматически, ее вводить (дублировать) не нужно.
                </div>
            </div>

            <!-- Блок "Расход" -->
            <div id="expense-block" class="section hidden">
                <div class="section-title">Расход</div>
                
                <div class="form-group">
                    <label for="amount-expense">Сумма:</label>
                    <input type="number" id="amount-expense" class="amount-input" step="0.01" placeholder="0,00">
                </div>

                <div class="form-group">
                    <label for="payment-date-expense">Дата оплаты:</label>
                    <input type="date" id="payment-date-expense" class="date-input">
                </div>

                <div class="form-group">
                    <label for="accrual-date-expense">Дата начисления:</label>
                    <input type="date" id="accrual-date-expense" class="date-input">
                </div>

                <div class="form-group">
                    <label for="article-expense">Статья:</label>
                    <div class="search-container">
                        <select id="article-expense" class="search-input">
                            <option value="">-- Выберите статью --</option>
                        </select>
                        <button class="btn add-btn" onclick="toggleSearch('article-expense')">🔍</button>
                    </div>
                    <div id="search-article-expense" class="hidden" style="position: relative; margin-top: 5px;">
                        <input type="text" placeholder="Поиск статьи..." onkeyup="searchArticles('expense', this.value)" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <div id="search-results-article-expense" class="search-results"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="contractor-expense">Контрагент:</label>
                    <div class="search-container">
                        <select id="contractor-expense" class="search-input">
                            <option value="">-- Выберите контрагента --</option>
                        </select>
                        <button class="btn add-btn" onclick="toggleSearch('contractor-expense')">🔍</button>
                        <button class="btn add-btn" onclick="showAddContractor('expense')">+</button>
                    </div>
                    <div id="search-contractor-expense" class="hidden" style="position: relative; margin-top: 5px;">
                        <input type="text" placeholder="Поиск контрагента..." onkeyup="searchContractors(this.value, 'expense')" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <div id="search-results-contractor-expense" class="search-results"></div>
                    </div>
                    <div id="add-contractor-expense" class="inline-add hidden">
                        <input type="text" id="new-contractor-expense" placeholder="Название нового контрагента">
                        <button class="btn add-btn" onclick="addNewContractor('expense')">Добавить</button>
                    </div>
                </div>

                <div class="form-group">
                    <label for="comment-expense">Комментарии:</label>
                    <textarea id="comment-expense" rows="3"></textarea>
                </div>

                <div class="info-text">
                    В данной форме отражаются только расходные операции.
                </div>
            </div>

            <!-- Блок "Приход" -->
            <div id="income-block" class="section hidden">
                <div class="section-title">Приход</div>
                
                <div class="form-group">
                    <label for="amount-income">Сумма:</label>
                    <input type="number" id="amount-income" class="amount-input" step="0.01" placeholder="0,00">
                </div>

                <div class="form-group">
                    <label for="payment-date-income">Дата оплаты:</label>
                    <input type="date" id="payment-date-income" class="date-input">
                </div>

                <div class="form-group">
                    <label for="accrual-date-income">Дата начисления:</label>
                    <input type="date" id="accrual-date-income" class="date-input">
                </div>

                <div class="form-group">
                    <label for="article-income">Статья:</label>
                    <div class="search-container">
                        <select id="article-income" class="search-input">
                            <option value="">-- Выберите статью --</option>
                        </select>
                        <button class="btn add-btn" onclick="toggleSearch('article-income')">🔍</button>
                    </div>
                    <div id="search-article-income" class="hidden" style="position: relative; margin-top: 5px;">
                        <input type="text" placeholder="Поиск статьи..." onkeyup="searchArticles('income', this.value)" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <div id="search-results-article-income" class="search-results"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="contractor-income">Контрагент:</label>
                    <div class="search-container">
                        <select id="contractor-income" class="search-input">
                            <option value="">-- Выберите контрагента --</option>
                        </select>
                        <button class="btn add-btn" onclick="toggleSearch('contractor-income')">🔍</button>
                        <button class="btn add-btn" onclick="showAddContractor('income')">+</button>
                    </div>
                    <div id="search-contractor-income" class="hidden" style="position: relative; margin-top: 5px;">
                        <input type="text" placeholder="Поиск контрагента..." onkeyup="searchContractors(this.value, 'income')" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <div id="search-results-contractor-income" class="search-results"></div>
                    </div>
                    <div id="add-contractor-income" class="inline-add hidden">
                        <input type="text" id="new-contractor-income" placeholder="Название нового контрагента">
                        <button class="btn add-btn" onclick="addNewContractor('income')">Добавить</button>
                    </div>
                </div>

                <div class="form-group">
                    <label for="comment-income">Комментарии:</label>
                    <textarea id="comment-income" rows="3"></textarea>
                </div>

                <div class="info-text">
                    В данной форме отражается только приходные операции.
                </div>
            </div>

            <!-- Кнопка отправки -->
            <div id="submit-section" class="section hidden">
                <button class="btn submit" onclick="submitForm()">Сохранить операцию</button>
                <button class="btn" onclick="resetForm()" style="margin-left: 20px;">Очистить форму</button>
            </div>

            <!-- История операций -->
            <div id="history-section" class="section hidden">
                <div class="section-title">История операций текущей сессии</div>
                <div class="table-container">
                    <table id="operations-history">
                        <thead>
                            <tr>
                                <th>Компания</th>
                                <th>Операция</th>
                                <th>Счет</th>
                                <th>Сумма</th>
                                <th>Дата оплаты</th>
                                <th>Статья</th>
                                <th>Контрагент</th>
                                <th>Действие</th>
                            </tr>
                        </thead>
                        <tbody id="history-tbody">
                        </tbody>
                    </table>
                    <div id="no-history" class="info-text">История операций пуста</div>
                </div>
            </div>

            <div id="form-message"></div>
        </div>
    </div>

    <script>
        // Глобальные переменные (объединение оригинальных и новых)
        let currentUser = '';
        let selectedCompany = '';
        let selectedOperation = '';
        let selectedAccount = '';
        let articlesExpenseCategories = {};
        let articlesIncomeCategories = {};
        let contractorsCategories = {};
        let operationsHistory = [];
        let operationCounter = 0;
        let sessionTimerInterval;

        // ФУНКЦИИ СЕССИЙ (новые)

        // Проверка сессии при загрузке страницы
        window.addEventListener('load', async function() {
            console.log('Страница загружена, проверяем сессию');
            try {
                const response = await fetch('/check-session');
                const result = await response.json();
                
                console.log('Результат проверки сессии:', result);
                
                if (result.success) {
                    currentUser = result.user;
                    document.getElementById('current-user-name').textContent = currentUser;
                    showMainForm();
                    await loadReferences();
                    startSessionTimer();
                } else {
                    showAuthForm();
                }
            } catch (error) {
                console.error('Ошибка при проверке сессии:', error);
                showAuthForm();
            }
        });

        // Показать форму авторизации
        function showAuthForm() {
            document.getElementById('auth-form').classList.remove('hidden');
            document.getElementById('main-form').classList.add('hidden');
            
            // Останавливаем таймер
            if (sessionTimerInterval) {
                clearInterval(sessionTimerInterval);
            }
        }

        // Показать основную форму
        function showMainForm() {
            document.getElementById('auth-form').classList.add('hidden');
            document.getElementById('main-form').classList.remove('hidden');
        }

        // Таймер сессии
        function startSessionTimer() {
            if (sessionTimerInterval) {
                clearInterval(sessionTimerInterval);
            }
            
            sessionTimerInterval = setInterval(async () => {
                try {
                    const response = await fetch('/check-session');
                    const result = await response.json();
                    
                    if (result.success && result.timeLeft) {
                        const minutes = Math.floor(result.timeLeft / 60);
                        const seconds = result.timeLeft % 60;
                        document.getElementById('timer-display').textContent = 
                            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                        
                        const timerDiv = document.getElementById('session-timer');
                        if (result.timeLeft < 300) { // Менее 5 минут
                            timerDiv.classList.add('warning');
                        } else {
                            timerDiv.classList.remove('warning');
                        }
                    } else {
                        // Сессия истекла
                        clearInterval(sessionTimerInterval);
                        alert('Сессия истекла. Необходимо войти заново.');
                        showAuthForm();
                    }
                } catch (error) {
                    console.error('Ошибка проверки сессии:', error);
                }
            }, 1000);
        }

        // Выход из системы
        async function logout() {
            try {
                const response = await fetch('/logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const result = await response.json();
                if (result.success) {
                    currentUser = '';
                    showAuthForm();
                }
            } catch (error) {
                console.error('Ошибка при выходе:', error);
                showAuthForm();
            }
        }

        // ОРИГИНАЛЬНЫЕ ФУНКЦИИ (восстановленные)

        // Аутентификация
        async function authenticate() {
            const login = document.getElementById('login').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('auth-error');

            if (!login || !password) {
                errorDiv.textContent = 'Введите логин и пароль';
                return;
            }

            try {
                const response = await fetch('/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ login, password })
                });

                const result = await response.json();

                if (result.success) {
                    currentUser = result.user;
                    document.getElementById('current-user-name').textContent = currentUser;
                    showMainForm();
                    await loadReferences();
                    startSessionTimer();
                    errorDiv.textContent = '';
                } else {
                    errorDiv.textContent = result.message;
                }
            } catch (error) {
                errorDiv.textContent = 'Произошла ошибка при аутентификации';
            }
        }

        // Обновленная загрузка справочников
        async function loadReferences() {
            try {
                const [expenseResponse, incomeResponse, contractorsResponse] = await Promise.all([
                    fetch('/api/articles/expense'),
                    fetch('/api/articles/income'),
                    fetch('/api/contractors')
                ]);

                const expenseResult = await expenseResponse.json();
                articlesExpenseCategories = expenseResult.success ? expenseResult.data : expenseResult.data;
                
                const incomeResult = await incomeResponse.json();
                articlesIncomeCategories = incomeResult.success ? incomeResult.data : incomeResult.data;
                
                const contractorsResult = await contractorsResponse.json();
                contractorsCategories = contractorsResult.success ? contractorsResult.data : contractorsResult.data;

                populateSelects();
            } catch (error) {
                console.error('Ошибка загрузки справочников:', error);
                // Устанавливаем дефолтные значения при ошибке
                articlesExpenseCategories = {
                    'Общие': ['Аренда офиса', 'Коммунальные услуги', 'Зарплата сотрудников']
                };
                articlesIncomeCategories = {
                    'Общие': ['Продажа товаров', 'Оказание услуг', 'Выполнение работ']
                };
                contractorsCategories = {
                    'Общие': ['ООО "Партнер А"', 'ИП Иванов И.И.']
                };
                populateSelects();
            }
        }

        // Улучшенная функция заполнения селектов
        function populateSelects() {
            // Статьи расходов с категориями
            const expenseSelect = document.getElementById('article-expense');
            expenseSelect.innerHTML = '<option value="">-- Выберите статью --</option>';
            
            // Проверяем, что articlesExpenseCategories существует и не пуст
            if (articlesExpenseCategories && Object.keys(articlesExpenseCategories).length > 0) {
                // Сортируем категории для консистентности
                const sortedCategories = Object.keys(articlesExpenseCategories).sort();
                
                sortedCategories.forEach(category => {
                    if (articlesExpenseCategories[category] && articlesExpenseCategories[category].length > 0) {
                        const optgroup = document.createElement('optgroup');
                        optgroup.label = `📁 ${category}`;
                        
                        // Сортируем статьи внутри категории
                        const sortedArticles = articlesExpenseCategories[category].sort();
                        
                        sortedArticles.forEach(article => {
                            const option = document.createElement('option');
                            option.value = article;
                            option.textContent = `  ${article}`;
                            optgroup.appendChild(option);
                        });
                        
                        expenseSelect.appendChild(optgroup);
                    }
                });
            }

            // Заполняем остальные селекты
            populateIncomeSelect();
            populateContractorSelects();
        }

        function populateIncomeSelect() {
            // Статьи доходов с категориями
            const incomeSelect = document.getElementById('article-income');
            incomeSelect.innerHTML = '<option value="">-- Выберите статью --</option>';
            
            // Проверяем, что articlesIncomeCategories существует и не пуст
            if (articlesIncomeCategories && Object.keys(articlesIncomeCategories).length > 0) {
                // Сортируем категории для консистентности
                const sortedCategories = Object.keys(articlesIncomeCategories).sort();
                
                sortedCategories.forEach(category => {
                    if (articlesIncomeCategories[category] && articlesIncomeCategories[category].length > 0) {
                        const optgroup = document.createElement('optgroup');
                        optgroup.label = `📁 ${category}`;
                        
                        // Сортируем статьи внутри категории
                        const sortedArticles = articlesIncomeCategories[category].sort();
                        
                        sortedArticles.forEach(article => {
                            const option = document.createElement('option');
                            option.value = article;
                            option.textContent = `  ${article}`;
                            optgroup.appendChild(option);
                        });
                        
                        incomeSelect.appendChild(optgroup);
                    }
                });
            }
        }

        function populateContractorSelects() {
            // Контрагенты с категориями
            const contractorSelects = ['contractor-expense', 'contractor-income'];
            contractorSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                select.innerHTML = '<option value="">-- Выберите контрагента --</option>';
                
                // Проверяем, что contractorsCategories существует и не пуст
                if (contractorsCategories && Object.keys(contractorsCategories).length > 0) {
                    // Сортируем категории для консистентности
                    const sortedCategories = Object.keys(contractorsCategories).sort();
                    
                    sortedCategories.forEach(category => {
                        if (contractorsCategories[category] && contractorsCategories[category].length > 0) {
                            const optgroup = document.createElement('optgroup');
                            optgroup.label = `👥 ${category}`;
                            
                            // Сортируем контрагентов внутри категории
                            const sortedContractors = contractorsCategories[category].sort();
                            
                            sortedContractors.forEach(contractor => {
                                const option = document.createElement('option');
                                option.value = contractor;
                                option.textContent = `  ${contractor}`;
                                optgroup.appendChild(option);
                            });
                            
                            select.appendChild(optgroup);
                        }
                    });
                }
            });
        }

        // Выбор компании
        function selectCompany(company) {
            if (document.getElementById('submit-section').classList.contains('hidden')) {
                selectedCompany = company;
                
                // Убираем активный класс со всех кнопок компании
                document.querySelectorAll('[id^="btn-company-"]').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // Добавляем активный класс к выбранной кнопке
                let buttonId;
                switch(company) {
                    case 'Мозаика':
                        buttonId = 'btn-company-mozaika';
                        break;
                    case 'Кампус':
                        buttonId = 'btn-company-kampus';
                        break;
                    case 'Хай-Гора':
                        buttonId = 'btn-company-haigora';
                        break;
                }
                
                if (buttonId) {
                    document.getElementById(buttonId).classList.add('active');
                }
                
                document.getElementById('operation-section').classList.remove('hidden');
            }
        }

        // Выбор операции
        function selectOperation(operation) {
            if (document.getElementById('submit-section').classList.contains('hidden')) {
                selectedOperation = operation;
                updateButtonState('operation', operation);
                document.getElementById('account-section').classList.remove('hidden');
            }
        }

        // Выбор счета
        function selectAccount(account) {
            if (document.getElementById('submit-section').classList.contains('hidden')) {
                selectedAccount = account;
                updateButtonState('account', account);
                showOperationBlock();
            }
        }

        // Обновление состояния кнопок
        function updateButtonState(type, value) {
            let buttons;
            if (type === 'company') {
                buttons = document.querySelectorAll('.section:first-of-type .btn');
            } else if (type === 'operation') {
                buttons = document.querySelectorAll('#operation-section .btn');
            } else if (type === 'account') {
                buttons = document.querySelectorAll('#account-section .btn');
            }

            buttons.forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.trim() === value) {
                    btn.classList.add('active');
                }
            });
        }

        // Показ блока операции
        function showOperationBlock() {
            // Блокируем все предыдущие секции
            document.querySelectorAll('.section').forEach((section, index) => {
                if (index < 3) { // Первые 3 секции (компания, операция, счет)
                    section.classList.add('locked');
                }
            });

            // Скрываем все блоки
            document.getElementById('transfer-internal-block').classList.add('hidden');
            document.getElementById('transfer-company-block').classList.add('hidden');
            document.getElementById('expense-block').classList.add('hidden');
            document.getElementById('income-block').classList.add('hidden');

            // Показываем нужный блок
            switch(selectedOperation) {
                case 'Перевод между счетами':
                    document.getElementById('transfer-internal-block').classList.remove('hidden');
                    setupInternalTransfer();
                    break;
                case 'Перевод между СВОИМИ компаниями':
                    document.getElementById('transfer-company-block').classList.remove('hidden');
                    setupCompanyTransfer();
                    break;
                case 'Расход':
                    document.getElementById('expense-block').classList.remove('hidden');
                    setupExpenseForm();
                    break;
                case 'Приход':
                    document.getElementById('income-block').classList.remove('hidden');
                    setupIncomeForm();
                    break;
            }

            document.getElementById('submit-section').classList.remove('hidden');
        }

        // Настройка формы внутреннего перевода
        function setupInternalTransfer() {
            const targetSelect = document.getElementById('target-account-internal');
            targetSelect.innerHTML = '<option value="">-- Выберите счет --</option>';
            
            const accounts = ['Касса', 'ИП-3564', 'ИП-7435', 'ИП-Акбарс', 'АНО-Сбер'];
            accounts.forEach(account => {
                if (account !== selectedAccount) {
                    const option = document.createElement('option');
                    option.value = account;
                    option.textContent = account;
                    targetSelect.appendChild(option);
                }
            });
        }

        // Настройка формы перевода между компаниями
        function setupCompanyTransfer() {
            const targetSelect = document.getElementById('target-company');
            targetSelect.innerHTML = '<option value="">-- Выберите компанию --</option>';
            
            const companies = ['Мозаика', 'Кампус', 'Хай-Гора'];
            companies.forEach(company => {
                if (company !== selectedCompany) {
                    const option = document.createElement('option');
                    option.value = company;
                    option.textContent = company;
                    targetSelect.appendChild(option);
                }
            });
        }

        // Настройка формы расходов
        function setupExpenseForm() {
            // Автозаполнение даты начисления при изменении даты оплаты
            document.getElementById('payment-date-expense').addEventListener('change', function() {
                const accrualDate = document.getElementById('accrual-date-expense');
                if (!accrualDate.value) {
                    accrualDate.value = this.value;
                }
            });
        }

        // Настройка формы доходов
        function setupIncomeForm() {
            // Автозаполнение даты начисления при изменении даты оплаты
            document.getElementById('payment-date-income').addEventListener('change', function() {
                const accrualDate = document.getElementById('accrual-date-income');
                if (!accrualDate.value) {
                    accrualDate.value = this.value;
                }
            });
        }

        // Переключение поиска
        function toggleSearch(fieldId) {
            const searchDiv = document.getElementById('search-' + fieldId);
            searchDiv.classList.toggle('hidden');
        }

        // Полностью исправленная функция поиска статей
        function searchArticles(type, query) {
            const resultsDiv = document.getElementById(`search-results-article-${type}`);
            
            if (!query || query.length < 2) {
                resultsDiv.innerHTML = '';
                resultsDiv.style.display = 'none';
                return;
            }

            let allArticles = [];
            
            if (type === 'expense') {
                // Поиск в расходах
                if (articlesExpenseCategories && Object.keys(articlesExpenseCategories).length > 0) {
                    Object.keys(articlesExpenseCategories).forEach(category => {
                        if (articlesExpenseCategories[category]) {
                            articlesExpenseCategories[category].forEach(article => {
                                if (article.toLowerCase().includes(query.toLowerCase())) {
                                    allArticles.push({ article, category });
                                }
                            });
                        }
                    });
                }
            } else if (type === 'income') {
                // Поиск в доходах
                if (articlesIncomeCategories && Object.keys(articlesIncomeCategories).length > 0) {
                    Object.keys(articlesIncomeCategories).forEach(category => {
                        if (articlesIncomeCategories[category]) {
                            articlesIncomeCategories[category].forEach(article => {
                                if (article.toLowerCase().includes(query.toLowerCase())) {
                                    allArticles.push({ article, category });
                                }
                            });
                        }
                    });
                }
            }

            resultsDiv.innerHTML = '';
            
            if (allArticles.length > 0) {
                // Ограничиваем количество результатов для производительности
                const limitedResults = allArticles.slice(0, 10);
                
                limitedResults.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'search-result-item';
                    
                    // Подсвечиваем найденный текст
                    const highlightedArticle = item.article.replace(
                        new RegExp(query, 'gi'), 
                        `<mark>$&</mark>`
                    );
                    
                    div.innerHTML = `
                        <div class="search-article-name">${highlightedArticle}</div>
                        <div class="search-category-name">📁 ${item.category}</div>
                    `;
                    
                    div.onclick = () => {
                        document.getElementById(`article-${type}`).value = item.article;
                        resultsDiv.innerHTML = '';
                        resultsDiv.style.display = 'none';
                        document.getElementById(`search-article-${type}`).classList.add('hidden');
                    };
                    resultsDiv.appendChild(div);
                });
                
                if (allArticles.length > 10) {
                    const moreDiv = document.createElement('div');
                    moreDiv.className = 'search-more-results';
                    moreDiv.textContent = `... и еще ${allArticles.length - 10} результатов`;
                    resultsDiv.appendChild(moreDiv);
                }
                
                resultsDiv.style.display = 'block';
            } else {
                const noResultsDiv = document.createElement('div');
                noResultsDiv.className = 'search-no-results';
                noResultsDiv.textContent = 'Ничего не найдено';
                resultsDiv.appendChild(noResultsDiv);
                resultsDiv.style.display = 'block';
            }
        }

            // Обновленная функция поиска контрагентов
            function searchContractors(query, type) {
                const resultsDiv = document.getElementById(`search-results-contractor-${type}`);
                
                if (!query || query.length < 2) {
                    resultsDiv.innerHTML = '';
                    resultsDiv.style.display = 'none';
                    return;
                }

                let allContractors = [];
                
                // Поиск в контрагентах
                if (contractorsCategories && Object.keys(contractorsCategories).length > 0) {
                    Object.keys(contractorsCategories).forEach(category => {
                        if (contractorsCategories[category]) {
                            contractorsCategories[category].forEach(contractor => {
                                if (contractor.toLowerCase().includes(query.toLowerCase())) {
                                    allContractors.push({ contractor, category });
                                }
                            });
                        }
                    });
                }

                resultsDiv.innerHTML = '';
                
                if (allContractors.length > 0) {
                    // Ограничиваем количество результатов для производительности
                    const limitedResults = allContractors.slice(0, 10);
                    
                    limitedResults.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'search-result-item';
                        
                        // Подсвечиваем найденный текст
                        const highlightedContractor = item.contractor.replace(
                            new RegExp(query, 'gi'), 
                            `<mark>$&</mark>`
                        );
                        
                        div.innerHTML = `
                            <div class="search-article-name">${highlightedContractor}</div>
                            <div class="search-category-name">👥 ${item.category}</div>
                        `;
                        
                        div.onclick = () => {
                            document.getElementById(`contractor-${type}`).value = item.contractor;
                            resultsDiv.innerHTML = '';
                            resultsDiv.style.display = 'none';
                            document.getElementById(`search-contractor-${type}`).classList.add('hidden');
                        };
                        resultsDiv.appendChild(div);
                    });
                    
                    if (allContractors.length > 10) {
                        const moreDiv = document.createElement('div');
                        moreDiv.className = 'search-more-results';
                        moreDiv.textContent = `... и еще ${allContractors.length - 10} результатов`;
                        resultsDiv.appendChild(moreDiv);
                    }
                    
                    resultsDiv.style.display = 'block';
                } else {
                    const noResultsDiv = document.createElement('div');
                    noResultsDiv.className = 'search-no-results';
                    noResultsDiv.textContent = 'Ничего не найдено';
                    resultsDiv.appendChild(noResultsDiv);
                    resultsDiv.style.display = 'block';
                }
            }

            // Показать форму добавления контрагента
            function showAddContractor(type) {
                document.getElementById(`add-contractor-${type}`).classList.toggle('hidden');
            }

            // Добавить нового контрагента
            async function addNewContractor(type) {
                const input = document.getElementById(`new-contractor-${type}`);
                const newContractor = input.value.trim();
                
                if (!newContractor) {
                    alert('Введите название контрагента');
                    return;
                }

                // Простой выбор категории
                const category = prompt('Введите категорию для контрагента (или оставьте пустым для "Прочие"):', 'Прочие');

                try {
                    const response = await fetch('/api/contractors/add', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ 
                            contractor: newContractor,
                            category: category || 'Прочие'
                        })
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        // Обновляем локальные данные
                        const targetCategory = category || 'Прочие';
                        if (!contractorsCategories[targetCategory]) {
                            contractorsCategories[targetCategory] = [];
                        }
                        contractorsCategories[targetCategory].push(newContractor);
                        
                        populateSelects();
                        document.getElementById(`contractor-${type}`).value = newContractor;
                        input.value = '';
                        document.getElementById(`add-contractor-${type}`).classList.add('hidden');
                    } else {
                        alert('Ошибка при добавлении контрагента: ' + result.message);
                    }
                } catch (error) {
                    alert('Произошла ошибка при добавлении контрагента');
                }
            }

            // Показать историю операций
            function showHistory() {
                const historySection = document.getElementById('history-section');
                const noHistory = document.getElementById('no-history');
                const historyTable = document.getElementById('operations-history');
                
                if (operationsHistory.length > 0) {
                    historySection.classList.remove('hidden');
                    noHistory.style.display = 'none';
                    historyTable.style.display = 'table';
                    updateHistoryTable();
                } else {
                    historySection.classList.remove('hidden');
                    noHistory.style.display = 'block';
                    historyTable.style.display = 'none';
                }
            }

            // Обновить таблицу истории
            function updateHistoryTable() {
                const tbody = document.getElementById('history-tbody');
                tbody.innerHTML = '';

                operationsHistory.forEach((operation, index) => {
                    const row = document.createElement('tr');
                    if (operation.deleted) {
                        row.classList.add('deleted-row');
                    }

                    row.innerHTML = `
                        <td>${operation.company}</td>
                        <td>${operation.operation}</td>
                        <td>${operation.accountDebit}</td>
                        <td>${operation.amount || '-'}</td>
                        <td>${operation.paymentDate || '-'}</td>
                        <td>${operation.article || '-'}</td>
                        <td>${operation.contractor || '-'}</td>
                        <td>
                            ${!operation.deleted ? 
                                `<button class="delete-btn" onclick="deleteOperation(${index})">×</button>` : 
                                '<span style="color: #dc3545;">Удалена</span>'
                            }
                        </td>
                    `;

                    tbody.appendChild(row);
                });
            }

            // Удалить операцию
            async function deleteOperation(index) {
                if (confirm('Вы уверены, что хотите удалить эту операцию?')) {
                    try {
                        const operation = operationsHistory[index];
                        
                        const response = await fetch('/delete-operation', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                operationId: operation.id,
                                timestamp: operation.timestamp
                            })
                        });

                        const result = await response.json();

                        if (result.success) {
                            operationsHistory[index].deleted = true;
                            updateHistoryTable();
                            
                            const messageDiv = document.getElementById('form-message');
                            messageDiv.innerHTML = '<div class="success">Операция помечена как удаленная</div>';
                            setTimeout(() => {
                                messageDiv.innerHTML = '';
                            }, 3000);
                        } else {
                            alert('Ошибка при удалении операции: ' + result.message);
                        }
                    } catch (error) {
                        alert('Произошла ошибка при удалении операции');
                    }
                }
            }

            // Добавить операцию в историю
            function addToHistory(formData) {
                operationCounter++;
                const historyItem = {
                    id: operationCounter,
                    timestamp: formData.timestamp,
                    company: formData.company,
                    operation: formData.operation,
                    accountDebit: formData.accountDebit,
                    amount: formData.amount,
                    paymentDate: formData.paymentDate,
                    article: formData.article,
                    contractor: formData.contractor,
                    deleted: false
                };

                operationsHistory.push(historyItem);
                showHistory();
            }

            // Отправка формы
        async function submitForm() {
            const messageDiv = document.getElementById('form-message');
            
            // Собираем базовые данные
            const formData = {
                timestamp: new Date().toLocaleString('ru-RU'),
                login: currentUser,
                company: selectedCompany,
                operation: selectedOperation,
                accountDebit: selectedAccount,
                status: 'активна'
            };

            // Собираем данные в зависимости от типа операции
            let isValid = true;
            let errorMessage = '';

            switch(selectedOperation) {
                case 'Перевод между счетами':
                    formData.amount = document.getElementById('amount-internal').value;
                    formData.paymentDate = document.getElementById('payment-date-internal').value;
                    formData.accountCredit = document.getElementById('target-account-internal').value;
                    formData.comments = document.getElementById('comment-internal').value;
                    
                    if (!formData.amount || !formData.paymentDate || !formData.accountCredit) {
                        isValid = false;
                        errorMessage = 'Заполните все обязательные поля';
                    }
                    break;

                case 'Перевод между СВОИМИ компаниями':
                    formData.amount = document.getElementById('amount-company').value;
                    formData.paymentDate = document.getElementById('payment-date-company').value;
                    formData.targetCompany = document.getElementById('target-company').value;
                    formData.accountCredit = document.getElementById('target-account-company').value;
                    formData.comments = document.getElementById('comment-company').value;
                    
                    if (!formData.amount || !formData.paymentDate || !formData.targetCompany || !formData.accountCredit) {
                        isValid = false;
                        errorMessage = 'Заполните все обязательные поля';
                    }
                    break;

                case 'Расход':
                    formData.amount = document.getElementById('amount-expense').value;
                    formData.paymentDate = document.getElementById('payment-date-expense').value;
                    formData.accrualDate = document.getElementById('accrual-date-expense').value;
                    formData.article = document.getElementById('article-expense').value;
                    formData.contractor = document.getElementById('contractor-expense').value;
                    formData.comments = document.getElementById('comment-expense').value;
                    
                    if (!formData.amount || !formData.paymentDate || !formData.accrualDate || !formData.article || !formData.contractor) {
                        isValid = false;
                        errorMessage = 'Заполните все обязательные поля';
                    }
                    break;

                case 'Приход':
                    formData.amount = document.getElementById('amount-income').value;
                    formData.paymentDate = document.getElementById('payment-date-income').value;
                    formData.accrualDate = document.getElementById('accrual-date-income').value;
                    formData.article = document.getElementById('article-income').value;
                    formData.contractor = document.getElementById('contractor-income').value;
                    formData.comments = document.getElementById('comment-income').value;
                    
                    if (!formData.amount || !formData.paymentDate || !formData.accrualDate || !formData.article || !formData.contractor) {
                        isValid = false;
                        errorMessage = 'Заполните все обязательные поля';
                    }
                    break;
            }

            if (!isValid) {
                messageDiv.innerHTML = `<div class="error">${errorMessage}</div>`;
                return;
            }

            try {
                const response = await fetch('/submit-operation', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();

                if (result.success) {
                    messageDiv.innerHTML = '<div class="success">Операция успешно сохранена!</div>';
                    
                    // Добавляем операцию в историю
                    addToHistory(formData);
                    
                    setTimeout(() => {
                        resetForm();
                    }, 2000);
                } else {
                    messageDiv.innerHTML = `<div class="error">${result.message}</div>`;
                }
            } catch (error) {
                console.error('Ошибка при сохранении операции:', error);
                messageDiv.innerHTML = '<div class="error">Произошла ошибка при сохранении операции</div>';
            }
        }

        // Добавить операцию в историю
        function addToHistory(formData) {
            operationCounter++;
            const historyItem = {
                id: operationCounter,
                timestamp: formData.timestamp,
                company: formData.company,
                operation: formData.operation,
                accountDebit: formData.accountDebit,
                amount: formData.amount,
                paymentDate: formData.paymentDate,
                article: formData.article,
                contractor: formData.contractor,
                deleted: false
            };

            operationsHistory.push(historyItem);
            showHistory();
        }

        // Показать историю операций
        function showHistory() {
            const historySection = document.getElementById('history-section');
            const noHistory = document.getElementById('no-history');
            const historyTable = document.getElementById('operations-history');
            
            if (operationsHistory.length > 0) {
                historySection.classList.remove('hidden');
                noHistory.style.display = 'none';
                historyTable.style.display = 'table';
                updateHistoryTable();
            } else {
                historySection.classList.remove('hidden');
                noHistory.style.display = 'block';
                historyTable.style.display = 'none';
            }
        }

        // Обновить таблицу истории
        function updateHistoryTable() {
            const tbody = document.getElementById('history-tbody');
            tbody.innerHTML = '';

            operationsHistory.forEach((operation, index) => {
                const row = document.createElement('tr');
                if (operation.deleted) {
                    row.classList.add('deleted-row');
                }

                row.innerHTML = `
                    <td>${operation.company}</td>
                    <td>${operation.operation}</td>
                    <td>${operation.accountDebit}</td>
                    <td>${operation.amount || '-'}</td>
                    <td>${operation.paymentDate || '-'}</td>
                    <td>${operation.article || '-'}</td>
                    <td>${operation.contractor || '-'}</td>
                    <td>
                        ${!operation.deleted ? 
                            `<button class="delete-btn" onclick="deleteOperation(${index})">×</button>` : 
                            '<span style="color: #dc3545;">Удалена</span>'
                        }
                    </td>
                `;

                tbody.appendChild(row);
            });
        }

        // Удалить операцию
        async function deleteOperation(index) {
            if (confirm('Вы уверены, что хотите удалить эту операцию?')) {
                try {
                    const operation = operationsHistory[index];
                    
                    const response = await fetch('/delete-operation', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            operationId: operation.id,
                            timestamp: operation.timestamp
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        operationsHistory[index].deleted = true;
                        updateHistoryTable();
                        
                        const messageDiv = document.getElementById('form-message');
                        messageDiv.innerHTML = '<div class="success">Операция помечена как удаленная</div>';
                        setTimeout(() => {
                            messageDiv.innerHTML = '';
                        }, 3000);
                    } else {
                        alert('Ошибка при удалении операции: ' + result.message);
                    }
                } catch (error) {
                    alert('Произошла ошибка при удалении операции');
                }
            }
        }

        // Сброс формы
        function resetForm() {
            selectedCompany = '';
            selectedOperation = '';
            selectedAccount = '';

            // Разблокируем все секции
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('locked');
            });

            // Скрываем все секции кроме первой и истории
            document.getElementById('operation-section').classList.add('hidden');
            document.getElementById('account-section').classList.add('hidden');
            document.getElementById('transfer-internal-block').classList.add('hidden');
            document.getElementById('transfer-company-block').classList.add('hidden');
            document.getElementById('expense-block').classList.add('hidden');
            document.getElementById('income-block').classList.add('hidden');
            document.getElementById('submit-section').classList.add('hidden');

            // Убираем активные состояния кнопок
            document.querySelectorAll('.btn.active').forEach(btn => {
                btn.classList.remove('active');
            });

            // Скрываем все поисковые блоки
            document.querySelectorAll('[id^="search-"]').forEach(element => {
                element.classList.add('hidden');
            });

            document.querySelectorAll('[id^="add-contractor-"]').forEach(element => {
                element.classList.add('hidden');
            });

            // Очищаем все поля
            document.querySelectorAll('input, select, textarea').forEach(field => {
                if (field.type !== 'password' && field.id !== 'login') {
                    field.value = '';
                }
            });

            // Очищаем сообщения
            document.getElementById('form-message').innerHTML = '';
        }

        // Обработка Enter в поле пароля
        document.getElementById('password').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                authenticate();
            }
        });

        // Обработка Enter в поле логина
        document.getElementById('login').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('password').focus();
            }
        });

        // Обработка активности пользователя для продления сессии
        let activityEvents = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'];
        let lastActivity = Date.now();

        activityEvents.forEach(event => {
            document.addEventListener(event, function() {
                let now = Date.now();
                // Отправляем запрос на сервер не чаще чем раз в 30 секунд
                if (now - lastActivity > 30000) {
                    lastActivity = now;
                    // Проверяем сессию, что автоматически обновит lastActivity на сервере
                    if (currentUser) {
                        fetch('/check-session').catch(err => console.log('Ошибка обновления активности:', err));
                    }
                }
            });
        });

    </script>
</body>
</html>