<UPDATED_CODE><!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–∏—Å—Ç–µ–º–∞ —É—á–µ—Ç–∞ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-attachment: fixed;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(120, 119, 198, 0.2) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            overflow: hidden;
        }

        #auth-form, #main-form {
            padding: 40px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2d3748;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        input, textarea, select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid rgba(102, 126, 234, 0.2);
            border-radius: 12px;
            font-size: 16px;
            box-sizing: border-box;
            background: rgba(255, 255, 255, 0.9);
            transition: all 0.3s ease;
            color: #2d3748;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
            background: rgba(255, 255, 255, 1);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 25px;
        }

        .btn {
            padding: 14px 24px;
            border: 2px solid #667eea;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            background: rgba(255, 255, 255, 0.9);
            color: #667eea;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
            transform: translateY(-1px);
        }

        .btn.submit {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            border-color: #48bb78;
            color: white;
            font-size: 18px;
            padding: 18px 36px;
            box-shadow: 0 10px 30px rgba(72, 187, 120, 0.3);
        }

        .btn.submit:hover {
            background: linear-gradient(135deg, #38a169 0%, #2f855a 100%);
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(72, 187, 120, 0.4);
        }

        .logout-btn {
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
            border-color: #f56565;
            color: white;
            padding: 10px 20px;
            font-size: 14px;
        }

        .logout-btn:hover {
            background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(245, 101, 101, 0.3);
        }

        .hidden {
            display: none;
        }

        .error {
            color: #e53e3e;
            margin-top: 15px;
            padding: 12px;
            background: rgba(245, 101, 101, 0.1);
            border-radius: 8px;
            border-left: 4px solid #e53e3e;
        }

        .success {
            color: #38a169;
            margin-top: 15px;
            padding: 12px;
            background: rgba(72, 187, 120, 0.1);
            border-radius: 8px;
            border-left: 4px solid #38a169;
        }

        .section {
            margin-bottom: 35px;
            padding: 25px;
            border: 1px solid rgba(102, 126, 234, 0.2);
            border-radius: 16px;
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(5px);
            transition: all 0.3s ease;
        }

        .section:hover {
            background: rgba(255, 255, 255, 0.8);
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .section-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
            color: #2d3748;
            position: relative;
            padding-bottom: 10px;
        }

        .section-title::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 50px;
            height: 3px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 2px;
        }

        .info-text {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            padding: 16px;
            border-radius: 12px;
            margin-top: 20px;
            font-style: italic;
            color: #4a5568;
            border-left: 4px solid #667eea;
        }

        .search-container {
            position: relative;
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(102, 126, 234, 0.2);
            border-top: none;
            max-height: 250px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            border-radius: 0 0 12px 12px;
            margin-top: 1px;
        }

        .search-result-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid rgba(102, 126, 234, 0.1);
            transition: all 0.2s ease;
        }

        .search-result-item:hover {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            transform: translateX(4px);
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .add-btn {
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
            border-color: #4299e1;
            color: white;
            padding: 12px 18px;
            font-size: 14px;
            min-width: 50px;
        }

        .add-btn:hover {
            background: linear-gradient(135deg, #3182ce 0%, #2c5282 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(66, 153, 225, 0.3);
        }

        .inline-add {
            display: flex;
            gap: 12px;
            margin-top: 15px;
        }

        .inline-add input {
            flex: 1;
        }

        .date-input, .amount-input {
            width: 220px;
        }

        .current-user {
            text-align: right;
            margin-bottom: 25px;
            color: #4a5568;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid rgba(102, 126, 234, 0.2);
        }

        .btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        .section.locked .btn:not(.active) {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        .table-container {
            margin-top: 25px;
            overflow-x: auto;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        #operations-history {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            overflow: hidden;
        }

        #operations-history th,
        #operations-history td {
            padding: 16px;
            text-align: left;
            border-bottom: 1px solid rgba(102, 126, 234, 0.1);
        }

        #operations-history th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-weight: 600;
            color: white;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 12px;
        }

        #operations-history tr:hover {
            background: rgba(102, 126, 234, 0.05);
        }

        .delete-btn {
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .delete-btn:hover {
            background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(245, 101, 101, 0.3);
        }

        .deleted-row {
            opacity: 0.5;
            text-decoration: line-through;
        }

        .deleted-row .delete-btn {
            display: none;
        }

        .session-timer {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 25px;
            text-align: center;
            font-weight: 600;
            color: #4a5568;
            border: 1px solid rgba(102, 126, 234, 0.2);
        }

        .session-timer.warning {
            background: linear-gradient(135deg, rgba(245, 101, 101, 0.1) 0%, rgba(229, 62, 62, 0.1) 100%);
            color: #c53030;
            border-color: rgba(245, 101, 101, 0.3);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        optgroup {
            font-weight: bold;
            color: #4a5568;
            background-color: rgba(102, 126, 234, 0.05);
            font-size: 14px;
        }

        optgroup option {
            font-weight: normal;
            color: #2d3748;
            padding-left: 10px;
            font-size: 14px;
        }

        .search-article-name {
            font-weight: 500;
            color: #2d3748;
            margin-bottom: 4px;
        }

        .search-category-name {
            font-size: 12px;
            color: #718096;
            font-style: italic;
        }

        .search-more-results {
            padding: 10px 16px;
            font-size: 12px;
            color: #718096;
            font-style: italic;
            background: rgba(102, 126, 234, 0.05);
        }

        .search-no-results {
            padding: 16px;
            font-size: 14px;
            color: #718096;
            text-align: center;
            font-style: italic;
        }

        mark {
            background: linear-gradient(135deg, #fef5e7 0%, #fed7aa 100%);
            padding: 2px 4px;
            border-radius: 4px;
            font-weight: 600;
        }

        select {
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23667eea' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 16px center;
            background-size: 16px;
            padding-right: 50px;
        }

        h2 {
            color: #2d3748;
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 30px;
            text-align: center;
            position: relative;
        }

        h2::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 4px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 2px;
        }

        /* –ê–Ω–∏–º–∞—Ü–∏–∏ –¥–ª—è –ø–æ—è–≤–ª–µ–Ω–∏—è —Å–µ–∫—Ü–∏–π */
        .section {
            animation: slideInUp 0.5s ease-out;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* –£–ª—É—á—à–µ–Ω–Ω—ã–µ —Å–∫—Ä–æ–ª–ª–±–∞—Ä—ã */
        .search-results::-webkit-scrollbar,
        .table-container::-webkit-scrollbar {
            width: 8px;
        }

        .search-results::-webkit-scrollbar-track,
        .table-container::-webkit-scrollbar-track {
            background: rgba(102, 126, 234, 0.1);
            border-radius: 4px;
        }

        .search-results::-webkit-scrollbar-thumb,
        .table-container::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 4px;
        }

        .search-results::-webkit-scrollbar-thumb:hover,
        .table-container::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            #auth-form, #main-form {
                padding: 20px;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                text-align: center;
            }
            
            .search-container {
                flex-direction: column;
                gap: 8px;
            }
            
            .inline-add {
                flex-direction: column;
            }
            
            .date-input, .amount-input {
                width: 100%;
            }
            
            .current-user {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
            
            #operations-history {
                font-size: 14px;
            }
            
            #operations-history th,
            #operations-history td {
                padding: 8px;
            }
        }

        @media (max-width: 480px) {
            h2 {
                font-size: 24px;
            }
            
            .section-title {
                font-size: 18px;
            }
            
            .btn {
                padding: 12px 16px;
                font-size: 14px;
            }
            
            .btn.submit {
                font-size: 16px;
                padding: 16px 24px;
            }
        }


    </style>
</head>
<body>
    <div class="container">
        <!-- –§–æ—Ä–º–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ -->
        <div id="auth-form">
            <h2>–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É —É—á–µ—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏–π</h2>
            <div class="form-group">
                <label for="login">–õ–æ–≥–∏–Ω:</label>
                <input type="text" id="login" required>
            </div>
            <div class="form-group">
                <label for="password">–ü–∞—Ä–æ–ª—å:</label>
                <input type="password" id="password" required>
            </div>
            <button class="btn submit" onclick="authenticate()">–í–æ–π—Ç–∏</button>
            <div id="auth-error" class="error"></div>
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–∞—è —Ñ–æ—Ä–º–∞ -->
        <div id="main-form" class="hidden">
            <!-- –¢–∞–π–º–µ—Ä —Å–µ—Å—Å–∏–∏ -->
            <div id="session-timer" class="session-timer">
                –í—Ä–µ–º—è –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏: <span id="timer-display">--:--</span>
            </div>
            
            <div class="current-user">
                <span>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <strong id="current-user-name"></strong></span>
                <button class="btn logout-btn" onclick="logout()">–í—ã–π—Ç–∏</button>
            </div>
            
            <h2>–£—á–µ—Ç —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π</h2>
            
            <!-- –í—ã–±–æ—Ä –∫–æ–º–ø–∞–Ω–∏–∏ -->
            <div class="section">
                <div class="section-title">1. –í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–ø–∞–Ω–∏—é:</div>
                <div class="button-group">
                    <button id="btn-company-mozaika" class="btn" onclick="selectCompany('–ú–æ–∑–∞–∏–∫–∞')">–ú–æ–∑–∞–∏–∫–∞</button>
                    <button id="btn-company-kampus" class="btn" onclick="selectCompany('–ö–∞–º–ø—É—Å')">–ö–∞–º–ø—É—Å</button>
                    <button id="btn-company-haigora" class="btn" onclick="selectCompany('–•–∞–π-–ì–æ—Ä–∞')">–•–∞–π-–ì–æ—Ä–∞</button>
                </div>
            </div>

            <!-- –í—ã–±–æ—Ä –æ–ø–µ—Ä–∞—Ü–∏–∏ -->
            <div id="operation-section" class="section hidden">
                <div class="section-title">2. –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏:</div>
                <div class="button-group">
                    <button class="btn" onclick="selectOperation('–ü—Ä–∏—Ö–æ–¥')">–ü—Ä–∏—Ö–æ–¥</button>
                    <button class="btn" onclick="selectOperation('–†–∞—Å—Ö–æ–¥')">–†–∞—Å—Ö–æ–¥</button>
                    <button class="btn" onclick="selectOperation('–ü–µ—Ä–µ–≤–æ–¥ –º–µ–∂–¥—É —Å—á–µ—Ç–∞–º–∏')">–ü–µ—Ä–µ–≤–æ–¥ –º–µ–∂–¥—É —Å—á–µ—Ç–∞–º–∏</button>
                    <button class="btn" onclick="selectOperation('–ü–µ—Ä–µ–≤–æ–¥ –º–µ–∂–¥—É –°–í–û–ò–ú–ò –∫–æ–º–ø–∞–Ω–∏—è–º–∏')">–ü–µ—Ä–µ–≤–æ–¥ –º–µ–∂–¥—É –°–í–û–ò–ú–ò –∫–æ–º–ø–∞–Ω–∏—è–º–∏</button>
                </div>
            </div>

            <!-- –í—ã–±–æ—Ä —Å—á–µ—Ç–∞ -->
            <div id="account-section" class="section hidden">
                <div class="section-title">3. –í—ã–±–µ—Ä–∏—Ç–µ —Å—á–µ—Ç —Å–ø–∏—Å–∞–Ω–∏—è:</div>
                <div class="button-group">
                    <button class="btn" onclick="selectAccount('–ö–∞—Å—Å–∞')">–ö–∞—Å—Å–∞</button>
                    <button class="btn" onclick="selectAccount('–ò–ü-3564')">–ò–ü-3564</button>
                    <button class="btn" onclick="selectAccount('–ò–ü-7435')">–ò–ü-7435</button>
                    <button class="btn" onclick="selectAccount('–ò–ü-–ê–∫–±–∞—Ä—Å')">–ò–ü-–ê–∫–±–∞—Ä—Å</button>
                    <button class="btn" onclick="selectAccount('–ê–ù–û-–°–±–µ—Ä')">–ê–ù–û-–°–±–µ—Ä</button>
                </div>
            </div>

            <!-- –ë–ª–æ–∫ "–ü–µ—Ä–µ–≤–æ–¥ –º–µ–∂–¥—É —Å—á–µ—Ç–∞–º–∏" -->
            <div id="transfer-internal-block" class="section hidden">
                <div class="section-title">–ü–µ—Ä–µ–≤–æ–¥ –º–µ–∂–¥—É —Å—á–µ—Ç–∞–º–∏</div>
                
                <div class="form-group">
                    <label for="amount-internal">–°—É–º–º–∞:</label>
                    <input type="number" id="amount-internal" class="amount-input" step="0.01" placeholder="0,00">
                </div>

                <div class="form-group">
                    <label for="payment-date-internal">–î–∞—Ç–∞ –æ–ø–ª–∞—Ç—ã:</label>
                    <input type="date" id="payment-date-internal" class="date-input">
                </div>

                <div class="form-group">
                    <label for="target-account-internal">–°—á–µ—Ç –¥–ª—è –∑–∞—á–∏—Å–ª–µ–Ω–∏—è:</label>
                    <select id="target-account-internal">
                        <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Å—á–µ—Ç --</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="comment-internal">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏:</label>
                    <textarea id="comment-internal" rows="3"></textarea>
                </div>

                <div class="info-text">
                    –í –¥–∞–Ω–Ω–æ–π —Ñ–æ—Ä–º–µ –æ—Ç—Ä–∞–∂–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–µ—Ä–µ–≤–æ–¥—ã –º–µ–∂–¥—É —Å—á–µ—Ç–∞–º–∏ –æ–¥–Ω–æ–π –∫–æ–º–ø–∞–Ω–∏–∏.
                </div>
            </div>

            <!-- –ë–ª–æ–∫ "–ü–µ—Ä–µ–≤–æ–¥ –º–µ–∂–¥—É –°–í–û–ò–ú–ò –∫–æ–º–ø–∞–Ω–∏—è–º–∏" -->
            <div id="transfer-company-block" class="section hidden">
                <div class="section-title">–ü–µ—Ä–µ–≤–æ–¥ –º–µ–∂–¥—É –°–í–û–ò–ú–ò –∫–æ–º–ø–∞–Ω–∏—è–º–∏</div>
                
                <div class="form-group">
                    <label for="amount-company">–°—É–º–º–∞:</label>
                    <input type="number" id="amount-company" class="amount-input" step="0.01" placeholder="0,00">
                </div>

                <div class="form-group">
                    <label for="payment-date-company">–î–∞—Ç–∞ –æ–ø–ª–∞—Ç—ã:</label>
                    <input type="date" id="payment-date-company" class="date-input">
                </div>

                <div class="form-group">
                    <label for="target-company">–ö–æ–º–ø–∞–Ω–∏—è –ø–æ–ª—É—á–∞—Ç–µ–ª—å:</label>
                    <select id="target-company">
                        <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–ø–∞–Ω–∏—é --</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="target-account-company">–°—á–µ—Ç –¥–ª—è –∑–∞—á–∏—Å–ª–µ–Ω–∏—è:</label>
                    <select id="target-account-company">
                        <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Å—á–µ—Ç --</option>
                        <option value="–ö–∞—Å—Å–∞">–ö–∞—Å—Å–∞</option>
                        <option value="–ò–ü-3564">–ò–ü-3564</option>
                        <option value="–ò–ü-7435">–ò–ü-7435</option>
                        <option value="–ò–ü-–ê–∫–±–∞—Ä—Å">–ò–ü-–ê–∫–±–∞—Ä—Å</option>
                        <option value="–ê–ù–û-–°–±–µ—Ä">–ê–ù–û-–°–±–µ—Ä</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="comment-company">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏:</label>
                    <textarea id="comment-company" rows="3"></textarea>
                </div>

                <div class="info-text">
                    –í –¥–∞–Ω–Ω–æ–π —Ñ–æ—Ä–º–µ –æ—Ç—Ä–∞–∂–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –†–ê–°–•–û–î–ù–ê–Ø –æ–ø–µ—Ä–∞—Ü–∏—è –ø–æ —Å—á–µ—Ç—É. –ü—Ä–∏—Ö–æ–¥ –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—É—é –∫–æ–º–ø–∞–Ω–∏—é –±—É–¥–µ—Ç –æ—Ç—Ä–∞–∂–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –µ–µ –≤–≤–æ–¥–∏—Ç—å (–¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å) –Ω–µ –Ω—É–∂–Ω–æ.
                </div>
            </div>

            <!-- –ë–ª–æ–∫ "–†–∞—Å—Ö–æ–¥" -->
            <div id="expense-block" class="section hidden">
                <div class="section-title">–†–∞—Å—Ö–æ–¥</div>
                
                <div class="form-group">
                    <label for="amount-expense">–°—É–º–º–∞:</label>
                    <input type="number" id="amount-expense" class="amount-input" step="0.01" placeholder="0,00">
                </div>

                <div class="form-group">
                    <label for="payment-date-expense">–î–∞—Ç–∞ –æ–ø–ª–∞—Ç—ã:</label>
                    <input type="date" id="payment-date-expense" class="date-input">
                </div>

                <div class="form-group">
                    <label for="accrual-date-expense">–î–∞—Ç–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è:</label>
                    <input type="date" id="accrual-date-expense" class="date-input">
                </div>

                <div class="form-group">
                    <label for="article-expense">–°—Ç–∞—Ç—å—è:</label>
                    <div class="search-container">
                        <select id="article-expense" class="search-input">
                            <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—å—é --</option>
                        </select>
                        <button class="btn add-btn" onclick="toggleSearch('article-expense')">üîç</button>
                    </div>
                    <div id="search-article-expense" class="hidden" style="position: relative; margin-top: 5px;">
                        <input type="text" placeholder="–ü–æ–∏—Å–∫ —Å—Ç–∞—Ç—å–∏..." onkeyup="searchArticles('expense', this.value)" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <div id="search-results-article-expense" class="search-results"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="contractor-expense">–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç:</label>
                    <div class="search-container">
                        <select id="contractor-expense" class="search-input">
                            <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞ --</option>
                        </select>
                        <button class="btn add-btn" onclick="toggleSearch('contractor-expense')">üîç</button>
                        <button class="btn add-btn" onclick="showAddContractor('expense')">+</button>
                    </div>
                    <div id="search-contractor-expense" class="hidden" style="position: relative; margin-top: 5px;">
                        <input type="text" placeholder="–ü–æ–∏—Å–∫ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞..." onkeyup="searchContractors(this.value, 'expense')" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <div id="search-results-contractor-expense" class="search-results"></div>
                    </div>
                    <div id="add-contractor-expense" class="inline-add hidden">
                        <input type="text" id="new-contractor-expense" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞">
                        <button class="btn add-btn" onclick="addNewContractor('expense')">–î–æ–±–∞–≤–∏—Ç—å</button>
                    </div>
                </div>

                <div class="form-group">
                    <label for="comment-expense">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏:</label>
                    <textarea id="comment-expense" rows="3"></textarea>
                </div>

                <div class="info-text">
                    –í –¥–∞–Ω–Ω–æ–π —Ñ–æ—Ä–º–µ –æ—Ç—Ä–∞–∂–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ —Ä–∞—Å—Ö–æ–¥–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏.
                </div>
            </div>

            <!-- –ë–ª–æ–∫ "–ü—Ä–∏—Ö–æ–¥" -->
            <div id="income-block" class="section hidden">
                <div class="section-title">–ü—Ä–∏—Ö–æ–¥</div>
                
                <div class="form-group">
                    <label for="amount-income">–°—É–º–º–∞:</label>
                    <input type="number" id="amount-income" class="amount-input" step="0.01" placeholder="0,00">
                </div>

                <div class="form-group">
                    <label for="payment-date-income">–î–∞—Ç–∞ –æ–ø–ª–∞—Ç—ã:</label>
                    <input type="date" id="payment-date-income" class="date-input">
                </div>

                <div class="form-group">
                    <label for="accrual-date-income">–î–∞—Ç–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è:</label>
                    <input type="date" id="accrual-date-income" class="date-input">
                </div>

                <div class="form-group">
                    <label for="article-income">–°—Ç–∞—Ç—å—è:</label>
                    <div class="search-container">
                        <select id="article-income" class="search-input">
                            <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—å—é --</option>
                        </select>
                        <button class="btn add-btn" onclick="toggleSearch('article-income')">üîç</button>
                    </div>
                    <div id="search-article-income" class="hidden" style="position: relative; margin-top: 5px;">
                        <input type="text" placeholder="–ü–æ–∏—Å–∫ —Å—Ç–∞—Ç—å–∏..." onkeyup="searchArticles('income', this.value)" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <div id="search-results-article-income" class="search-results"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="contractor-income">–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç:</label>
                    <div class="search-container">
                        <select id="contractor-income" class="search-input">
                            <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞ --</option>
                        </select>
                        <button class="btn add-btn" onclick="toggleSearch('contractor-income')">üîç</button>
                        <button class="btn add-btn" onclick="showAddContractor('income')">+</button>
                    </div>
                    <div id="search-contractor-income" class="hidden" style="position: relative; margin-top: 5px;">
                        <input type="text" placeholder="–ü–æ–∏—Å–∫ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞..." onkeyup="searchContractors(this.value, 'income')" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <div id="search-results-contractor-income" class="search-results"></div>
                    </div>
                    <div id="add-contractor-income" class="inline-add hidden">
                        <input type="text" id="new-contractor-income" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞">
                        <button class="btn add-btn" onclick="addNewContractor('income')">–î–æ–±–∞–≤–∏—Ç—å</button>
                    </div>
                </div>

                <div class="form-group">
                    <label for="comment-income">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏:</label>
                    <textarea id="comment-income" rows="3"></textarea>
                </div>

                <div class="info-text">
                    –í –¥–∞–Ω–Ω–æ–π —Ñ–æ—Ä–º–µ –æ—Ç—Ä–∞–∂–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏—Ö–æ–¥–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏.
                </div>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
            <div id="submit-section" class="section hidden">
                <button class="btn submit" onclick="submitForm()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é</button>
                <button class="btn" onclick="resetForm()" style="margin-left: 20px;">–û—á–∏—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º—É</button>
            </div>

            <!-- –ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π -->
            <div id="history-section" class="section hidden">
                <div class="section-title">–ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏</div>
                <div class="table-container">
                    <table id="operations-history">
                        <thead>
                            <tr>
                                <th>–ö–æ–º–ø–∞–Ω–∏—è</th>
                                <th>–û–ø–µ—Ä–∞—Ü–∏—è</th>
                                <th>–°—á–µ—Ç</th>
                                <th>–°—É–º–º–∞</th>
                                <th>–î–∞—Ç–∞ –æ–ø–ª–∞—Ç—ã</th>
                                <th>–°—Ç–∞—Ç—å—è</th>
                                <th>–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç</th>
                                <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
                            </tr>
                        </thead>
                        <tbody id="history-tbody">
                        </tbody>
                    </table>
                    <div id="no-history" class="info-text">–ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π –ø—É—Å—Ç–∞</div>
                </div>
            </div>

            <div id="form-message"></div>
        </div>
    </div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (–æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã—Ö –∏ –Ω–æ–≤—ã—Ö)
        let currentUser = '';
        let selectedCompany = '';
        let selectedOperation = '';
        let selectedAccount = '';
        let articlesExpenseCategories = {};
        let articlesIncomeCategories = {};
        let contractorsCategories = {};
        let operationsHistory = [];
        let operationCounter = 0;
        let sessionTimerInterval;

        // –§–£–ù–ö–¶–ò–ò –°–ï–°–°–ò–ô (–Ω–æ–≤—ã–µ)

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Å—Å–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('load', async function() {
            console.log('–°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–µ—Å—Å–∏—é');
            try {
                const response = await fetch('/check-session');
                const result = await response.json();
                
                console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–µ—Å—Å–∏–∏:', result);
                
                if (result.success) {
                    currentUser = result.user;
                    document.getElementById('current-user-name').textContent = currentUser;
                    showMainForm();
                    await loadReferences();
                    startSessionTimer();
                } else {
                    showAuthForm();
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å–µ—Å—Å–∏–∏:', error);
                showAuthForm();
            }
        });

        // –ü–æ–∫–∞–∑–∞—Ç—å —Ñ–æ—Ä–º—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        function showAuthForm() {
            document.getElementById('auth-form').classList.remove('hidden');
            document.getElementById('main-form').classList.add('hidden');
            
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–µ—Ä
            if (sessionTimerInterval) {
                clearInterval(sessionTimerInterval);
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –æ—Å–Ω–æ–≤–Ω—É—é —Ñ–æ—Ä–º—É
        function showMainForm() {
            document.getElementById('auth-form').classList.add('hidden');
            document.getElementById('main-form').classList.remove('hidden');
        }

        // –¢–∞–π–º–µ—Ä —Å–µ—Å—Å–∏–∏
        function startSessionTimer() {
            if (sessionTimerInterval) {
                clearInterval(sessionTimerInterval);
            }
            
            sessionTimerInterval = setInterval(async () => {
                try {
                    const response = await fetch('/check-session');
                    const result = await response.json();
                    
                    if (result.success && result.timeLeft) {
                        const minutes = Math.floor(result.timeLeft / 60);
                        const seconds = result.timeLeft % 60;
                        document.getElementById('timer-display').textContent = 
                            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                        
                        const timerDiv = document.getElementById('session-timer');
                        if (result.timeLeft < 300) { // –ú–µ–Ω–µ–µ 5 –º–∏–Ω—É—Ç
                            timerDiv.classList.add('warning');
                        } else {
                            timerDiv.classList.remove('warning');
                        }
                    } else {
                        // –°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞
                        clearInterval(sessionTimerInterval);
                        alert('–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –∑–∞–Ω–æ–≤–æ.');
                        showAuthForm();
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–µ—Å—Å–∏–∏:', error);
                }
            }, 1000);
        }

        // –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã
        async function logout() {
            try {
                const response = await fetch('/logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const result = await response.json();
                if (result.success) {
                    currentUser = '';
                    showAuthForm();
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ:', error);
                showAuthForm();
            }
        }

        // –û–†–ò–ì–ò–ù–ê–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò (–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ)

        // –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
        async function authenticate() {
            const login = document.getElementById('login').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('auth-error');

            if (!login || !password) {
                errorDiv.textContent = '–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å';
                return;
            }

            try {
                const response = await fetch('/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ login, password })
                });

                const result = await response.json();

                if (result.success) {
                    currentUser = result.user;
                    document.getElementById('current-user-name').textContent = currentUser;
                    showMainForm();
                    await loadReferences();
                    startSessionTimer();
                    errorDiv.textContent = '';
                } else {
                    errorDiv.textContent = result.message;
                }
            } catch (error) {
                errorDiv.textContent = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏';
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤
        async function loadReferences() {
            try {
                const [expenseResponse, incomeResponse, contractorsResponse] = await Promise.all([
                    fetch('/api/articles/expense'),
                    fetch('/api/articles/income'),
                    fetch('/api/contractors')
                ]);

                const expenseResult = await expenseResponse.json();
                articlesExpenseCategories = expenseResult.success ? expenseResult.data : expenseResult.data;
                
                const incomeResult = await incomeResponse.json();
                articlesIncomeCategories = incomeResult.success ? incomeResult.data : incomeResult.data;
                
                const contractorsResult = await contractorsResponse.json();
                contractorsCategories = contractorsResult.success ? contractorsResult.data : contractorsResult.data;

                populateSelects();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤:', error);
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø—Ä–∏ –æ—à–∏–±–∫–µ
                articlesExpenseCategories = {
                    '–û–±—â–∏–µ': ['–ê—Ä–µ–Ω–¥–∞ –æ—Ñ–∏—Å–∞', '–ö–æ–º–º—É–Ω–∞–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏', '–ó–∞—Ä–ø–ª–∞—Ç–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤']
                };
                articlesIncomeCategories = {
                    '–û–±—â–∏–µ': ['–ü—Ä–æ–¥–∞–∂–∞ —Ç–æ–≤–∞—Ä–æ–≤', '–û–∫–∞–∑–∞–Ω–∏–µ —É—Å–ª—É–≥', '–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ä–∞–±–æ—Ç']
                };
                contractorsCategories = {
                    '–û–±—â–∏–µ': ['–û–û–û "–ü–∞—Ä—Ç–Ω–µ—Ä –ê"', '–ò–ü –ò–≤–∞–Ω–æ–≤ –ò.–ò.']
                };
                populateSelects();
            }
        }

        // –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è —Å–µ–ª–µ–∫—Ç–æ–≤
        function populateSelects() {
            // –°—Ç–∞—Ç—å–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤ —Å –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏
            const expenseSelect = document.getElementById('article-expense');
            expenseSelect.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—å—é --</option>';
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ articlesExpenseCategories —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –Ω–µ –ø—É—Å—Ç
            if (articlesExpenseCategories && Object.keys(articlesExpenseCategories).length > 0) {
                // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–ª—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
                const sortedCategories = Object.keys(articlesExpenseCategories).sort();
                
                sortedCategories.forEach(category => {
                    if (articlesExpenseCategories[category] && articlesExpenseCategories[category].length > 0) {
                        const optgroup = document.createElement('optgroup');
                        optgroup.label = `üìÅ ${category}`;
                        
                        // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Å—Ç–∞—Ç—å–∏ –≤–Ω—É—Ç—Ä–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                        const sortedArticles = articlesExpenseCategories[category].sort();
                        
                        sortedArticles.forEach(article => {
                            const option = document.createElement('option');
                            option.value = article;
                            option.textContent = `  ${article}`;
                            optgroup.appendChild(option);
                        });
                        
                        expenseSelect.appendChild(optgroup);
                    }
                });
            }

            // –ó–∞–ø–æ–ª–Ω—è–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å–µ–ª–µ–∫—Ç—ã
            populateIncomeSelect();
            populateContractorSelects();
        }

        function populateIncomeSelect() {
            // –°—Ç–∞—Ç—å–∏ –¥–æ—Ö–æ–¥–æ–≤ —Å –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏
            const incomeSelect = document.getElementById('article-income');
            incomeSelect.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—å—é --</option>';
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ articlesIncomeCategories —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –Ω–µ –ø—É—Å—Ç
            if (articlesIncomeCategories && Object.keys(articlesIncomeCategories).length > 0) {
                // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–ª—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
                const sortedCategories = Object.keys(articlesIncomeCategories).sort();
                
                sortedCategories.forEach(category => {
                    if (articlesIncomeCategories[category] && articlesIncomeCategories[category].length > 0) {
                        const optgroup = document.createElement('optgroup');
                        optgroup.label = `üìÅ ${category}`;
                        
                        // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Å—Ç–∞—Ç—å–∏ –≤–Ω—É—Ç—Ä–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                        const sortedArticles = articlesIncomeCategories[category].sort();
                        
                        sortedArticles.forEach(article => {
                            const option = document.createElement('option');
                            option.value = article;
                            option.textContent = `  ${article}`;
                            optgroup.appendChild(option);
                        });
                        
                        incomeSelect.appendChild(optgroup);
                    }
                });
            }
        }

        function populateContractorSelects() {
            // –ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç—ã —Å –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏
            const contractorSelects = ['contractor-expense', 'contractor-income'];
            contractorSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                select.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞ --</option>';
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ contractorsCategories —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –Ω–µ –ø—É—Å—Ç
                if (contractorsCategories && Object.keys(contractorsCategories).length > 0) {
                    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–ª—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
                    const sortedCategories = Object.keys(contractorsCategories).sort();
                    
                    sortedCategories.forEach(category => {
                        if (contractorsCategories[category] && contractorsCategories[category].length > 0) {
                            const optgroup = document.createElement('optgroup');
                            optgroup.label = `üë• ${category}`;
                            
                            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤ –≤–Ω—É—Ç—Ä–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                            const sortedContractors = contractorsCategories[category].sort();
                            
                            sortedContractors.forEach(contractor => {
                                const option = document.createElement('option');
                                option.value = contractor;
                                option.textContent = `  ${contractor}`;
                                optgroup.appendChild(option);
                            });
                            
                            select.appendChild(optgroup);
                        }
                    });
                }
            });
        }

        // –í—ã–±–æ—Ä –∫–æ–º–ø–∞–Ω–∏–∏
        function selectCompany(company) {
            if (document.getElementById('submit-section').classList.contains('hidden')) {
                selectedCompany = company;
                
                // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å–æ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫ –∫–æ–º–ø–∞–Ω–∏–∏
                document.querySelectorAll('[id^="btn-company-"]').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–Ω–æ–ø–∫–µ
                let buttonId;
                switch(company) {
                    case '–ú–æ–∑–∞–∏–∫–∞':
                        buttonId = 'btn-company-mozaika';
                        break;
                    case '–ö–∞–º–ø—É—Å':
                        buttonId = 'btn-company-kampus';
                        break;
                    case '–•–∞–π-–ì–æ—Ä–∞':
                        buttonId = 'btn-company-haigora';
                        break;
                }
                
                if (buttonId) {
                    document.getElementById(buttonId).classList.add('active');
                }
                
                document.getElementById('operation-section').classList.remove('hidden');
            }
        }

        // –í—ã–±–æ—Ä –æ–ø–µ—Ä–∞—Ü–∏–∏
        function selectOperation(operation) {
            if (document.getElementById('submit-section').classList.contains('hidden')) {
                selectedOperation = operation;
                updateButtonState('operation', operation);
                document.getElementById('account-section').classList.remove('hidden');
            }
        }

        // –í—ã–±–æ—Ä —Å—á–µ—Ç–∞
        function selectAccount(account) {
            if (document.getElementById('submit-section').classList.contains('hidden')) {
                selectedAccount = account;
                updateButtonState('account', account);
                showOperationBlock();
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–Ω–æ–ø–æ–∫
        function updateButtonState(type, value) {
            let buttons;
            if (type === 'company') {
                buttons = document.querySelectorAll('.section:first-of-type .btn');
            } else if (type === 'operation') {
                buttons = document.querySelectorAll('#operation-section .btn');
            } else if (type === 'account') {
                buttons = document.querySelectorAll('#account-section .btn');
            }

            buttons.forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.trim() === value) {
                    btn.classList.add('active');
                }
            });
        }

        // –ü–æ–∫–∞–∑ –±–ª–æ–∫–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏
        function showOperationBlock() {
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –≤—Å–µ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–µ–∫—Ü–∏–∏
            document.querySelectorAll('.section').forEach((section, index) => {
                if (index < 3) { // –ü–µ—Ä–≤—ã–µ 3 —Å–µ–∫—Ü–∏–∏ (–∫–æ–º–ø–∞–Ω–∏—è, –æ–ø–µ—Ä–∞—Ü–∏—è, —Å—á–µ—Ç)
                    section.classList.add('locked');
                }
            });

            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –±–ª–æ–∫–∏
            document.getElementById('transfer-internal-block').classList.add('hidden');
            document.getElementById('transfer-company-block').classList.add('hidden');
            document.getElementById('expense-block').classList.add('hidden');
            document.getElementById('income-block').classList.add('hidden');

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—ã–π –±–ª–æ–∫
            switch(selectedOperation) {
                case '–ü–µ—Ä–µ–≤–æ–¥ –º–µ–∂–¥—É —Å—á–µ—Ç–∞–º–∏':
                    document.getElementById('transfer-internal-block').classList.remove('hidden');
                    setupInternalTransfer();
                    break;
                case '–ü–µ—Ä–µ–≤–æ–¥ –º–µ–∂–¥—É –°–í–û–ò–ú–ò –∫–æ–º–ø–∞–Ω–∏—è–º–∏':
                    document.getElementById('transfer-company-block').classList.remove('hidden');
                    setupCompanyTransfer();
                    break;
                case '–†–∞—Å—Ö–æ–¥':
                    document.getElementById('expense-block').classList.remove('hidden');
                    setupExpenseForm();
                    break;
                case '–ü—Ä–∏—Ö–æ–¥':
                    document.getElementById('income-block').classList.remove('hidden');
                    setupIncomeForm();
                    break;
            }

            document.getElementById('submit-section').classList.remove('hidden');
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ñ–æ—Ä–º—ã –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –ø–µ—Ä–µ–≤–æ–¥–∞
        function setupInternalTransfer() {
            const targetSelect = document.getElementById('target-account-internal');
            targetSelect.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Å—á–µ—Ç --</option>';
            
            const accounts = ['–ö–∞—Å—Å–∞', '–ò–ü-3564', '–ò–ü-7435', '–ò–ü-–ê–∫–±–∞—Ä—Å', '–ê–ù–û-–°–±–µ—Ä'];
            accounts.forEach(account => {
                if (account !== selectedAccount) {
                    const option = document.createElement('option');
                    option.value = account;
                    option.textContent = account;
                    targetSelect.appendChild(option);
                }
            });
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ñ–æ—Ä–º—ã –ø–µ—Ä–µ–≤–æ–¥–∞ –º–µ–∂–¥—É –∫–æ–º–ø–∞–Ω–∏—è–º–∏
        function setupCompanyTransfer() {
            const targetSelect = document.getElementById('target-company');
            targetSelect.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–ø–∞–Ω–∏—é --</option>';
            
            const companies = ['–ú–æ–∑–∞–∏–∫–∞', '–ö–∞–º–ø—É—Å', '–•–∞–π-–ì–æ—Ä–∞'];
            companies.forEach(company => {
                if (company !== selectedCompany) {
                    const option = document.createElement('option');
                    option.value = company;
                    option.textContent = company;
                    targetSelect.appendChild(option);
                }
            });
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ñ–æ—Ä–º—ã —Ä–∞—Å—Ö–æ–¥–æ–≤
        function setupExpenseForm() {
            // –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–∞—Ç—ã –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –¥–∞—Ç—ã –æ–ø–ª–∞—Ç—ã
            document.getElementById('payment-date-expense').addEventListener('change', function() {
                const accrualDate = document.getElementById('accrual-date-expense');
                if (!accrualDate.value) {
                    accrualDate.value = this.value;
                }
            });
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ñ–æ—Ä–º—ã –¥–æ—Ö–æ–¥–æ–≤
        function setupIncomeForm() {
            // –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–∞—Ç—ã –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –¥–∞—Ç—ã –æ–ø–ª–∞—Ç—ã
            document.getElementById('payment-date-income').addEventListener('change', function() {
                const accrualDate = document.getElementById('accrual-date-income');
                if (!accrualDate.value) {
                    accrualDate.value = this.value;
                }
            });
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø–æ–∏—Å–∫–∞
        function toggleSearch(fieldId) {
            const searchDiv = document.getElementById('search-' + fieldId);
            searchDiv.classList.toggle('hidden');
        }

        // –ü–æ–ª–Ω–æ—Å—Ç—å—é –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–∏—Å–∫–∞ —Å—Ç–∞—Ç–µ–π
        function searchArticles(type, query) {
            const resultsDiv = document.getElementById(`search-results-article-${type}`);
            
            if (!query || query.length < 2) {
                resultsDiv.innerHTML = '';
                resultsDiv.style.display = 'none';
                return;
            }

            let allArticles = [];
            
            if (type === 'expense') {
                // –ü–æ–∏—Å–∫ –≤ —Ä–∞—Å—Ö–æ–¥–∞—Ö
                if (articlesExpenseCategories && Object.keys(articlesExpenseCategories).length > 0) {
                    Object.keys(articlesExpenseCategories).forEach(category => {
                        if (articlesExpenseCategories[category]) {
                            articlesExpenseCategories[category].forEach(article => {
                                if (article.toLowerCase().includes(query.toLowerCase())) {
                                    allArticles.push({ article, category });
                                }
                            });
                        }
                    });
                }
            } else if (type === 'income') {
                // –ü–æ–∏—Å–∫ –≤ –¥–æ—Ö–æ–¥–∞—Ö
                if (articlesIncomeCategories && Object.keys(articlesIncomeCategories).length > 0) {
                    Object.keys(articlesIncomeCategories).forEach(category => {
                        if (articlesIncomeCategories[category]) {
                            articlesIncomeCategories[category].forEach(article => {
                                if (article.toLowerCase().includes(query.toLowerCase())) {
                                    allArticles.push({ article, category });
                                }
                            });
                        }
                    });
                }
            }

            resultsDiv.innerHTML = '';
            
            if (allArticles.length > 0) {
                // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
                const limitedResults = allArticles.slice(0, 10);
                
                limitedResults.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'search-result-item';
                    
                    // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –Ω–∞–π–¥–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
                    const highlightedArticle = item.article.replace(
                        new RegExp(query, 'gi'), 
                        `<mark>$&</mark>`
                    );
                    
                    div.innerHTML = `
                        <div class="search-article-name">${highlightedArticle}</div>
                        <div class="search-category-name">üìÅ ${item.category}</div>
                    `;
                    
                    div.onclick = () => {
                        document.getElementById(`article-${type}`).value = item.article;
                        resultsDiv.innerHTML = '';
                        resultsDiv.style.display = 'none';
                        document.getElementById(`search-article-${type}`).classList.add('hidden');
                    };
                    resultsDiv.appendChild(div);
                });
                
                if (allArticles.length > 10) {
                    const moreDiv = document.createElement('div');
                    moreDiv.className = 'search-more-results';
                    moreDiv.textContent = `... –∏ –µ—â–µ ${allArticles.length - 10} —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤`;
                    resultsDiv.appendChild(moreDiv);
                }
                
                resultsDiv.style.display = 'block';
            } else {
                const noResultsDiv = document.createElement('div');
                noResultsDiv.className = 'search-no-results';
                noResultsDiv.textContent = '–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ';
                resultsDiv.appendChild(noResultsDiv);
                resultsDiv.style.display = 'block';
            }
        }

            // –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–∏—Å–∫–∞ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤
            function searchContractors(query, type) {
                const resultsDiv = document.getElementById(`search-results-contractor-${type}`);
                
                if (!query || query.length < 2) {
                    resultsDiv.innerHTML = '';
                    resultsDiv.style.display = 'none';
                    return;
                }

                let allContractors = [];
                
                // –ü–æ–∏—Å–∫ –≤ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞—Ö
                if (contractorsCategories && Object.keys(contractorsCategories).length > 0) {
                    Object.keys(contractorsCategories).forEach(category => {
                        if (contractorsCategories[category]) {
                            contractorsCategories[category].forEach(contractor => {
                                if (contractor.toLowerCase().includes(query.toLowerCase())) {
                                    allContractors.push({ contractor, category });
                                }
                            });
                        }
                    });
                }

                resultsDiv.innerHTML = '';
                
                if (allContractors.length > 0) {
                    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
                    const limitedResults = allContractors.slice(0, 10);
                    
                    limitedResults.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'search-result-item';
                        
                        // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –Ω–∞–π–¥–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
                        const highlightedContractor = item.contractor.replace(
                            new RegExp(query, 'gi'), 
                            `<mark>$&</mark>`
                        );
                        
                        div.innerHTML = `
                            <div class="search-article-name">${highlightedContractor}</div>
                            <div class="search-category-name">üë• ${item.category}</div>
                        `;
                        
                        div.onclick = () => {
                            document.getElementById(`contractor-${type}`).value = item.contractor;
                            resultsDiv.innerHTML = '';
                            resultsDiv.style.display = 'none';
                            document.getElementById(`search-contractor-${type}`).classList.add('hidden');
                        };
                        resultsDiv.appendChild(div);
                    });
                    
                    if (allContractors.length > 10) {
                        const moreDiv = document.createElement('div');
                        moreDiv.className = 'search-more-results';
                        moreDiv.textContent = `... –∏ –µ—â–µ ${allContractors.length - 10} —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤`;
                        resultsDiv.appendChild(moreDiv);
                    }
                    
                    resultsDiv.style.display = 'block';
                } else {
                    const noResultsDiv = document.createElement('div');
                    noResultsDiv.className = 'search-no-results';
                    noResultsDiv.textContent = '–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ';
                    resultsDiv.appendChild(noResultsDiv);
                    resultsDiv.style.display = 'block';
                }
            }

            // –ü–æ–∫–∞–∑–∞—Ç—å —Ñ–æ—Ä–º—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞
            function showAddContractor(type) {
                document.getElementById(`add-contractor-${type}`).classList.toggle('hidden');
            }

            // –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–≥–æ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞
            async function addNewContractor(type) {
                const input = document.getElementById(`new-contractor-${type}`);
                const newContractor = input.value.trim();
                
                if (!newContractor) {
                    alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞');
                    return;
                }

                // –ü—Ä–æ—Å—Ç–æ–π –≤—ã–±–æ—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                const category = prompt('–í–≤–µ–¥–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –¥–ª—è –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞ (–∏–ª–∏ –æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è "–ü—Ä–æ—á–∏–µ"):', '–ü—Ä–æ—á–∏–µ');

                try {
                    const response = await fetch('/api/contractors/add', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ 
                            contractor: newContractor,
                            category: category || '–ü—Ä–æ—á–∏–µ'
                        })
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                        const targetCategory = category || '–ü—Ä–æ—á–∏–µ';
                        if (!contractorsCategories[targetCategory]) {
                            contractorsCategories[targetCategory] = [];
                        }
                        contractorsCategories[targetCategory].push(newContractor);
                        
                        populateSelects();
                        document.getElementById(`contractor-${type}`).value = newContractor;
                        input.value = '';
                        document.getElementById(`add-contractor-${type}`).classList.add('hidden');
                    } else {
                        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞: ' + result.message);
                    }
                } catch (error) {
                    alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞');
                }
            }

            // –ü–æ–∫–∞–∑–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é –æ–ø–µ—Ä–∞—Ü–∏–π
            function showHistory() {
                const historySection = document.getElementById('history-section');
                const noHistory = document.getElementById('no-history');
                const historyTable = document.getElementById('operations-history');
                
                if (operationsHistory.length > 0) {
                    historySection.classList.remove('hidden');
                    noHistory.style.display = 'none';
                    historyTable.style.display = 'table';
                    updateHistoryTable();
                } else {
                    historySection.classList.remove('hidden');
                    noHistory.style.display = 'block';
                    historyTable.style.display = 'none';
                }
            }

            // –û–±–Ω–æ–≤–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É –∏—Å—Ç–æ—Ä–∏–∏
            function updateHistoryTable() {
                const tbody = document.getElementById('history-tbody');
                tbody.innerHTML = '';

                operationsHistory.forEach((operation, index) => {
                    const row = document.createElement('tr');
                    if (operation.deleted) {
                        row.classList.add('deleted-row');
                    }

                    row.innerHTML = `
                        <td>${operation.company}</td>
                        <td>${operation.operation}</td>
                        <td>${operation.accountDebit}</td>
                        <td>${operation.amount || '-'}</td>
                        <td>${operation.paymentDate || '-'}</td>
                        <td>${operation.article || '-'}</td>
                        <td>${operation.contractor || '-'}</td>
                        <td>
                            ${!operation.deleted ? 
                                `<button class="delete-btn" onclick="deleteOperation(${index})">√ó</button>` : 
                                '<span style="color: #dc3545;">–£–¥–∞–ª–µ–Ω–∞</span>'
                            }
                        </td>
                    `;

                    tbody.appendChild(row);
                });
            }

            // –£–¥–∞–ª–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é
            async function deleteOperation(index) {
                if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –æ–ø–µ—Ä–∞—Ü–∏—é?')) {
                    try {
                        const operation = operationsHistory[index];
                        
                        const response = await fetch('/delete-operation', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                operationId: operation.id,
                                timestamp: operation.timestamp
                            })
                        });

                        const result = await response.json();

                        if (result.success) {
                            operationsHistory[index].deleted = true;
                            updateHistoryTable();
                            
                            const messageDiv = document.getElementById('form-message');
                            messageDiv.innerHTML = '<div class="success">–û–ø–µ—Ä–∞—Ü–∏—è –ø–æ–º–µ—á–µ–Ω–∞ –∫–∞–∫ —É–¥–∞–ª–µ–Ω–Ω–∞—è</div>';
                            setTimeout(() => {
                                messageDiv.innerHTML = '';
                            }, 3000);
                        } else {
                            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –æ–ø–µ—Ä–∞—Ü–∏–∏: ' + result.message);
                        }
                    } catch (error) {
                        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –æ–ø–µ—Ä–∞—Ü–∏–∏');
                    }
                }
            }

            // –î–æ–±–∞–≤–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é –≤ –∏—Å—Ç–æ—Ä–∏—é
            function addToHistory(formData) {
                operationCounter++;
                const historyItem = {
                    id: operationCounter,
                    timestamp: formData.timestamp,
                    company: formData.company,
                    operation: formData.operation,
                    accountDebit: formData.accountDebit,
                    amount: formData.amount,
                    paymentDate: formData.paymentDate,
                    article: formData.article,
                    contractor: formData.contractor,
                    deleted: false
                };

                operationsHistory.push(historyItem);
                showHistory();
            }

            // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã
        async function submitForm() {
            const messageDiv = document.getElementById('form-message');
            
            // –°–æ–±–∏—Ä–∞–µ–º –±–∞–∑–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
            const formData = {
                timestamp: new Date().toLocaleString('ru-RU'),
                login: currentUser,
                company: selectedCompany,
                operation: selectedOperation,
                accountDebit: selectedAccount,
                status: '–∞–∫—Ç–∏–≤–Ω–∞'
            };

            // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏
            let isValid = true;
            let errorMessage = '';

            switch(selectedOperation) {
                case '–ü–µ—Ä–µ–≤–æ–¥ –º–µ–∂–¥—É —Å—á–µ—Ç–∞–º–∏':
                    formData.amount = document.getElementById('amount-internal').value;
                    formData.paymentDate = document.getElementById('payment-date-internal').value;
                    formData.accountCredit = document.getElementById('target-account-internal').value;
                    formData.comments = document.getElementById('comment-internal').value;
                    
                    if (!formData.amount || !formData.paymentDate || !formData.accountCredit) {
                        isValid = false;
                        errorMessage = '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è';
                    }
                    break;

                case '–ü–µ—Ä–µ–≤–æ–¥ –º–µ–∂–¥—É –°–í–û–ò–ú–ò –∫–æ–º–ø–∞–Ω–∏—è–º–∏':
                    formData.amount = document.getElementById('amount-company').value;
                    formData.paymentDate = document.getElementById('payment-date-company').value;
                    formData.targetCompany = document.getElementById('target-company').value;
                    formData.accountCredit = document.getElementById('target-account-company').value;
                    formData.comments = document.getElementById('comment-company').value;
                    
                    if (!formData.amount || !formData.paymentDate || !formData.targetCompany || !formData.accountCredit) {
                        isValid = false;
                        errorMessage = '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è';
                    }
                    break;

                case '–†–∞—Å—Ö–æ–¥':
                    formData.amount = document.getElementById('amount-expense').value;
                    formData.paymentDate = document.getElementById('payment-date-expense').value;
                    formData.accrualDate = document.getElementById('accrual-date-expense').value;
                    formData.article = document.getElementById('article-expense').value;
                    formData.contractor = document.getElementById('contractor-expense').value;
                    formData.comments = document.getElementById('comment-expense').value;
                    
                    if (!formData.amount || !formData.paymentDate || !formData.accrualDate || !formData.article || !formData.contractor) {
                        isValid = false;
                        errorMessage = '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è';
                    }
                    break;

                case '–ü—Ä–∏—Ö–æ–¥':
                    formData.amount = document.getElementById('amount-income').value;
                    formData.paymentDate = document.getElementById('payment-date-income').value;
                    formData.accrualDate = document.getElementById('accrual-date-income').value;
                    formData.article = document.getElementById('article-income').value;
                    formData.contractor = document.getElementById('contractor-income').value;
                    formData.comments = document.getElementById('comment-income').value;
                    
                    if (!formData.amount || !formData.paymentDate || !formData.accrualDate || !formData.article || !formData.contractor) {
                        isValid = false;
                        errorMessage = '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è';
                    }
                    break;
            }

            if (!isValid) {
                messageDiv.innerHTML = `<div class="error">${errorMessage}</div>`;
                return;
            }

            try {
                const response = await fetch('/submit-operation', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();

                if (result.success) {
                    messageDiv.innerHTML = '<div class="success">–û–ø–µ—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!</div>';
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –æ–ø–µ—Ä–∞—Ü–∏—é –≤ –∏—Å—Ç–æ—Ä–∏—é
                    addToHistory(formData);
                    
                    setTimeout(() => {
                        resetForm();
                    }, 2000);
                } else {
                    messageDiv.innerHTML = `<div class="error">${result.message}</div>`;
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –æ–ø–µ—Ä–∞—Ü–∏–∏:', error);
                messageDiv.innerHTML = '<div class="error">–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –æ–ø–µ—Ä–∞—Ü–∏–∏</div>';
            }
        }

        // –î–æ–±–∞–≤–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é –≤ –∏—Å—Ç–æ—Ä–∏—é
        function addToHistory(formData) {
            operationCounter++;
            const historyItem = {
                id: operationCounter,
                timestamp: formData.timestamp,
                company: formData.company,
                operation: formData.operation,
                accountDebit: formData.accountDebit,
                amount: formData.amount,
                paymentDate: formData.paymentDate,
                article: formData.article,
                contractor: formData.contractor,
                deleted: false
            };

            operationsHistory.push(historyItem);
            showHistory();
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é –æ–ø–µ—Ä–∞—Ü–∏–π
        function showHistory() {
            const historySection = document.getElementById('history-section');
            const noHistory = document.getElementById('no-history');
            const historyTable = document.getElementById('operations-history');
            
            if (operationsHistory.length > 0) {
                historySection.classList.remove('hidden');
                noHistory.style.display = 'none';
                historyTable.style.display = 'table';
                updateHistoryTable();
            } else {
                historySection.classList.remove('hidden');
                noHistory.style.display = 'block';
                historyTable.style.display = 'none';
            }
        }

        // –û–±–Ω–æ–≤–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É –∏—Å—Ç–æ—Ä–∏–∏
        function updateHistoryTable() {
            const tbody = document.getElementById('history-tbody');
            tbody.innerHTML = '';

            operationsHistory.forEach((operation, index) => {
                const row = document.createElement('tr');
                if (operation.deleted) {
                    row.classList.add('deleted-row');
                }

                row.innerHTML = `
                    <td>${operation.company}</td>
                    <td>${operation.operation}</td>
                    <td>${operation.accountDebit}</td>
                    <td>${operation.amount || '-'}</td>
                    <td>${operation.paymentDate || '-'}</td>
                    <td>${operation.article || '-'}</td>
                    <td>${operation.contractor || '-'}</td>
                    <td>
                        ${!operation.deleted ? 
                            `<button class="delete-btn" onclick="deleteOperation(${index})">√ó</button>` : 
                            '<span style="color: #dc3545;">–£–¥–∞–ª–µ–Ω–∞</span>'
                        }
                    </td>
                `;

                tbody.appendChild(row);
            });
        }

        // –£–¥–∞–ª–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é
        async function deleteOperation(index) {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –æ–ø–µ—Ä–∞—Ü–∏—é?')) {
                try {
                    const operation = operationsHistory[index];
                    
                    const response = await fetch('/delete-operation', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            operationId: operation.id,
                            timestamp: operation.timestamp
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        operationsHistory[index].deleted = true;
                        updateHistoryTable();
                        
                        const messageDiv = document.getElementById('form-message');
                        messageDiv.innerHTML = '<div class="success">–û–ø–µ—Ä–∞—Ü–∏—è –ø–æ–º–µ—á–µ–Ω–∞ –∫–∞–∫ —É–¥–∞–ª–µ–Ω–Ω–∞—è</div>';
                        setTimeout(() => {
                            messageDiv.innerHTML = '';
                        }, 3000);
                    } else {
                        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –æ–ø–µ—Ä–∞—Ü–∏–∏: ' + result.message);
                    }
                } catch (error) {
                    alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –æ–ø–µ—Ä–∞—Ü–∏–∏');
                }
            }
        }

        // –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã
        function resetForm() {
            selectedCompany = '';
            selectedOperation = '';
            selectedAccount = '';

            // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –≤—Å–µ —Å–µ–∫—Ü–∏–∏
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('locked');
            });

            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Å–µ–∫—Ü–∏–∏ –∫—Ä–æ–º–µ –ø–µ—Ä–≤–æ–π –∏ –∏—Å—Ç–æ—Ä–∏–∏
            document.getElementById('operation-section').classList.add('hidden');
            document.getElementById('account-section').classList.add('hidden');
            document.getElementById('transfer-internal-block').classList.add('hidden');
            document.getElementById('transfer-company-block').classList.add('hidden');
            document.getElementById('expense-block').classList.add('hidden');
            document.getElementById('income-block').classList.add('hidden');
            document.getElementById('submit-section').classList.add('hidden');

            // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–Ω–æ–ø–æ–∫
            document.querySelectorAll('.btn.active').forEach(btn => {
                btn.classList.remove('active');
            });

            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –ø–æ–∏—Å–∫–æ–≤—ã–µ –±–ª–æ–∫–∏
            document.querySelectorAll('[id^="search-"]').forEach(element => {
                element.classList.add('hidden');
            });

            document.querySelectorAll('[id^="add-contractor-"]').forEach(element => {
                element.classList.add('hidden');
            });

            // –û—á–∏—â–∞–µ–º –≤—Å–µ –ø–æ–ª—è
            document.querySelectorAll('input, select, textarea').forEach(field => {
                if (field.type !== 'password' && field.id !== 'login') {
                    field.value = '';
                }
            });

            // –û—á–∏—â–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
            document.getElementById('form-message').innerHTML = '';
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter –≤ –ø–æ–ª–µ –ø–∞—Ä–æ–ª—è
        document.getElementById('password').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                authenticate();
            }
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter –≤ –ø–æ–ª–µ –ª–æ–≥–∏–Ω–∞
        document.getElementById('login').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('password').focus();
            }
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø—Ä–æ–¥–ª–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏
        let activityEvents = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'];
        let lastActivity = Date.now();

        activityEvents.forEach(event => {
            document.addEventListener(event, function() {
                let now = Date.now();
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä –Ω–µ —á–∞—â–µ —á–µ–º —Ä–∞–∑ –≤ 30 —Å–µ–∫—É–Ω–¥
                if (now - lastActivity > 30000) {
                    lastActivity = now;
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–µ—Å—Å–∏—é, —á—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–∏—Ç lastActivity –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
                    if (currentUser) {
                        fetch('/check-session').catch(err => console.log('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏:', err));
                    }
                }
            });
        });

    </script>
</body>
</html>